<!DOCTYPE html>

<html>
<head>
<!-- allow fancy checkmarks to show up -->
<meta charset="UTF-8">

<script>
	// complain about uncaught errors
	window.addEventListener('error', () => document.documentElement.style.background = 'red');
</script>

<!-- jQuery -->
<script
	src="https://code.jquery.com/jquery-3.6.0.min.js"
	integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
	crossorigin="anonymous"></script>

<!-- mocha test framework -->
<script src="../node_modules/mocha/mocha.js"></script>
<link rel="stylesheet" href="../node_modules/mocha/mocha.css" />

<!-- home-grown assertions -->
<script src="support/assert.js"></script>

<!-- configure mocha and chai -->
<script>
const post_xunit_to = new URLSearchParams(location.search).get('post_xunit_to');

mocha.setup({
	ui: 'tdd',
	reporter: post_xunit_to ? 'xunit' : 'html'
});

let xunit = '';
Mocha.process.stdout.write = (line) => xunit += line;
</script>

<!-- include the library with the tests inlined -->
<script id="mathquill" src="../dist/mathquill.test.js"
	onerror="alert('Couldn\'t find `dist/mathquill.test.js`. Please run `npm run devbuild` before opening this file.')">
</script>

<!-- include MathQuill-basic -->
<link rel="stylesheet" href="../build/mathquill.css" />
<!--<script src="../dist/mathquill-basic.js"></script>-->
<script>
	//MQBasic = MathQuill.noConflict().getInterface();
	MQ = MathQuill.getInterface();
</script>

</head>

<body>
<h1>Unit Tests</h1>
<div id="mocha"></div>
<div id="mock"></div>

<script>
	teardown(() => $('#mock').empty());
	const runner = mocha.run();

	if (post_xunit_to) {
		// the following is based on
		// https://github.com/saucelabs-sample-scripts/JavaScript/blob/4946c5cf0ab7325dce5562881dba7c28e30989e5/reporting_mocha.js
		const failedTests = [];
		runner.on('fail', (test, err) => {
			const flattenTitles = (test) => {
				const titles = [];
				while (test.parent.title) {
					titles.push(test.parent.title);
					test = test.parent;
				}
				return titles.reverse();
			}

			failedTests.push({
				name: test.title,
				result: false,
				message: err.message,
				stack: err.stack,
				titles: flattenTitles(test)
			});
		});

		runner.on('end', () => {
			setTimeout(() => {
				$.post(post_xunit_to, xunit).complete(function() {
					window.mochaResults = runner.stats;
					window.mochaResults.reports = failedTests;
				});
			});
		});
	}
</script>
</body>
</html>

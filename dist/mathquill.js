(()=>{"use strict";
/* @license
 * MathQuill, by Han, Jeanine, and Mary
 * http://mathquill.com | maintainers@mathquill.com
 *
 * Rewritten for the purposes of WeBWorK.
 * https://github.com/openwebwork
 *
 * This Source Code Form is subject to the terms of the
 * Mozilla Public License, v. 2.0. If a copy of the MPL
 * was not distributed with this file, You can obtain
 * one at http://mozilla.org/MPL/2.0/.
 */
const t=window.jQuery,e="mathquill-command-id",s="mathquill-block-id",i=-1;if(!t)throw"MathQuill requires jQuery 1.9+ to be loaded first";t.fn.extend({insDirOf:function(t,e){return t===i?this.insertBefore(e.first()):this.insertAfter(e.last())},insAtDirEnd:function(t,e){return t===i?this.prependTo(e):this.appendTo(e)}});const r=()=>{},n=t=>(e,s,i)=>t("function"==typeof e?e:t=>{if(e in t)return t[e](s,i)}),o=(t,...e)=>class extends t{constructor(...t){super(...e)}},l=(t,e=!1)=>{if(!e)throw new Error(`prayer failed: ${t}`)},a=t=>{l("a direction was passed",t===i||1===t)},h=(t,e,s)=>{l("a parent is always present",!!t),l("leftward is properly set up",e?e[1]===s&&e.parent===t:(null==t?void 0:t.ends[i])===s),l("rightward is properly set up",s?s[i]===e&&s.parent===t:(null==t?void 0:t.ends[1])===e)},c={},d={},u={"(":")",")":"(","[":"]","]":"[","{":"}","}":"{","\\{":"\\}","\\}":"\\{","&lang;":"&rang;","&rang;":"&lang;","\\langle ":"\\rangle ","\\rangle ":"\\langle ","|":"|","\\lVert ":"\\rVert ","\\rVert ":"\\lVert "},p={},f={};for(const t of["arg","deg","det","dim","exp","gcd","hom","ker","lg","lim","ln","log","max","min","sup","limsup","liminf","injlim","projlim","Pr"])f[t]=1;for(const t of["sin","cos","tan","arcsin","arccos","arctan","sinh","cosh","tanh","sec","csc","cot","coth"])f[t]=1;const m={limsup:1,liminf:1,projlim:1,injlim:1},v=(()=>{const e={8:"Backspace",9:"Tab",10:"Enter",13:"Enter",16:"Shift",17:"Control",18:"Alt",20:"CapsLock",27:"Esc",32:"Spacebar",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",45:"Insert",46:"Del",144:"NumLock"};return(s,i)=>{let n=null,o=null;const l=t(s),a=t(i.container||l);let h,c=r;const d=t=>{c=t,clearTimeout(h),h=setTimeout(t)},u=t=>{d((e=>{c=r,clearTimeout(h),t(e)}))};a.on("keydown keypress input keyup focusout paste",(t=>c(t)));let p=!1;const f=()=>{var t;return null===(t=i.keystroke)||void 0===t?void 0:t.call(i,(t=>{const s=t.which||t.keyCode,i=e[s],r=[];t.ctrlKey&&r.push("Ctrl"),t.originalEvent&&t.originalEvent instanceof KeyboardEvent&&t.originalEvent.metaKey&&r.push("Meta"),t.altKey&&r.push("Alt"),t.shiftKey&&r.push("Shift");const n=i||String.fromCharCode(s);return r.length||i?(r.push(n),r.join("-")):n})(n),n)},m=()=>{if((()=>{const t=l[0];return"selectionStart"in t&&t.selectionStart!==t.selectionEnd})())return;const t=l.val();1===t.length?(l.val(""),i.typedText(t)):t&&l[0].select&&l[0].select()},v=()=>{const t=l.val();l.val(""),t&&i.paste(t)};return a.on({keydown:t=>{t.target===l[0]&&(n=t,o=null,p&&u((t=>{t&&"focusout"===t.type||!l[0].select||l[0].select()})),f())},keypress:t=>{t.target===l[0]&&(n&&o&&f(),o=t,d(m))},keyup:t=>{t.target===l[0]&&n&&!o&&d(m)},focusout:()=>{n=o=null},cut:()=>u((()=>i.cut())),copy:()=>u((()=>i.copy())),paste:t=>{t.target===l[0]&&(l.focus(),d(v))}}),{select:t=>{c(),c=r,clearTimeout(h),l.val(t),t&&l[0].select&&l[0].select(),p=!!t}}}})();class g{constructor(){this.ignoreNextMousedown=()=>!1}static config(t,e){Object.assign(t,e)}get mouseEvents(){var t;return null!==(t=this._mouseEvents)&&void 0!==t?t:g.mouseEvents}set mouseEvents(t){this._mouseEvents=t}get autoCommands(){var t;return null!==(t=this._autoCommands)&&void 0!==t?t:g.autoCommands}set autoCommands(t){if("object"==typeof t)return void(this._autoCommands=t);if(!/^[a-z]+(?: [a-z]+)*$/i.test(t))throw`"${t}" not a space-delimited list of only letters`;const e=t.split(" "),s={_maxLength:0};for(const t of e){if(t.length<2)throw`autocommand "${t}" not minimum length of 2`;if(t in f)throw`"${t}" is a built-in operator name`;s[t]=1,s._maxLength=Math.max(s._maxLength,t.length)}this._autoCommands=s}get autoOperatorNames(){var t;return null!==(t=this._autoOperatorNames)&&void 0!==t?t:g.autoOperatorNames}set autoOperatorNames(t){if("object"==typeof t)return void(this._autoCommands=t);if(!/^[a-z]+(?: [a-z]+)*$/i.test(t))throw`"${t}" not a space-delimited list of only letters`;const e=t.split(" "),s={_maxLength:0};for(const t of e){if(t.length<2)throw`"${t}" not minimum length of 2`;s[t]=1,s._maxLength=Math.max(s._maxLength,t.length)}this._autoOperatorNames=s}get charsThatBreakOutOfSupSub(){var t;return null!==(t=this._charsThatBreakOutOfSupSub)&&void 0!==t?t:g.charsThatBreakOutOfSupSub}set charsThatBreakOutOfSupSub(t){this._charsThatBreakOutOfSupSub=t}get statelessClipboard(){var t;return null!==(t=this._statelessClipboard)&&void 0!==t?t:g.statelessClipboard}set statelessClipboard(t){this._statelessClipboard=t}get spaceBehavesLikeTab(){var t;return null!==(t=this._spaceBehavesLikeTab)&&void 0!==t?t:g.spaceBehavesLikeTab}set spaceBehavesLikeTab(t){this._spaceBehavesLikeTab=t}get leftRightIntoCmdGoes(){var t;return null!==(t=this._leftRightIntoCmdGoes)&&void 0!==t?t:g.leftRightIntoCmdGoes}set leftRightIntoCmdGoes(t){if(t&&"up"!==t&&"down"!==t)throw`"up" or "down" required for leftRightIntoCmdGoes option, got "${t}"`;this._leftRightIntoCmdGoes=t}get restrictMismatchedBrackets(){var t;return null!==(t=this._restrictMismatchedBrackes)&&void 0!==t?t:g.restrictMismatchedBrackets}set restrictMismatchedBrackets(t){this._restrictMismatchedBrackes=t}get sumStartsWithNEquals(){var t;return null!==(t=this._sumStartsWithNEquals)&&void 0!==t?t:g.sumStartsWithNEquals}set sumStartsWithNEquals(t){this._sumStartsWithNEquals=t}get supSubsRequireOperand(){var t;return null!==(t=this._supSubsRequireOperand)&&void 0!==t?t:g.supSubsRequireOperand}set supSubsRequireOperand(t){this._supSubsRequireOperand=t}get rootsAreExponents(){var t;return null!==(t=this._rootsAreExponents)&&void 0!==t?t:g.rootsAreExponents}set rootsAreExponents(t){this._rootsAreExponents=t}get noExtraFractionParens(){var t;return null!==(t=this._noExtraFractionParens)&&void 0!==t?t:g.noExtraFractionParens}set noExtraFractionParens(t){this._noExtraFractionParens=t}get maxDepth(){var t;return null!==(t=this._maxDepth)&&void 0!==t?t:g.maxDepth}set maxDepth(t){"number"==typeof t&&(this._maxDepth=t)}get autoSubscriptNumerals(){var t;return null!==(t=this._autoSubscriptNumerals)&&void 0!==t?t:g.autoSubscriptNumerals}set autoSubscriptNumerals(t){this._autoSubscriptNumerals=t}get typingSlashWritesDivisionSymbol(){var t;return null!==(t=this._typingSlashWritesDivisionSymbol)&&void 0!==t?t:g.typingSlashWritesDivisionSymbol}set typingSlashWritesDivisionSymbol(t){this._typingSlashWritesDivisionSymbol=t}get typingAsteriskWritesTimesSymbol(){var t;return null!==(t=this._typingAsteriskWritesTimesSymbol)&&void 0!==t?t:g.typingAsteriskWritesTimesSymbol}set typingAsteriskWritesTimesSymbol(t){this._typingAsteriskWritesTimesSymbol=t}substituteTextarea(){return t("<textarea autocapitalize=off autocomplete=off autocorrect=off spellcheck=false />")[0]}substituteKeyboardEvents(t,e){return v(t,e)}}g.mouseEvents=!0,g.autoCommands={_maxLength:0},g.autoOperatorNames=(()=>{const t={_maxLength:9};for(const e of["arg","deg","det","dim","exp","gcd","hom","ker","lg","lim","ln","log","max","min","sup","limsup","liminf","injlim","projlim","Pr"])t[e]=1;for(const e of["sin","cos","tan","sec","cosec","csc","cotan","cot","ctg"])t[e]=t[`arc${e}`]=t[`${e}h`]=t[`ar${e}h`]=t[`arc${e}h`]=1;for(const e of["gcf","hcf","lcm","proj","span"])t[e]=1;return t})(),g.charsThatBreakOutOfSupSub="",g.statelessClipboard=!1,g.spaceBehavesLikeTab=!1,g.leftRightIntoCmdGoes=void 0,g.restrictMismatchedBrackets=!1,g.sumStartsWithNEquals=!1,g.supSubsRequireOperand=!1,g.rootsAreExponents=!1,g.noExtraFractionParens=!1,g.maxDepth=void 0,g.autoSubscriptNumerals=!1,g.typingSlashWritesDivisionSymbol=!1,g.typingAsteriskWritesTimesSymbol=!1;class b{constructor(e,s,r=i){if(this.jQ=t(),this.ends={},this.each=n((t=>{var e;let s=this.ends[i];if(!s)return this;for(;s!==(null===(e=this.ends[1])||void 0===e?void 0:e[1])&&!1!==t(s);s=null==s?void 0:s[1]);return this})),l("no half-empty fragments",!e==!s),!e)return;l("withDir is passed to Fragment",e instanceof q),l("oppDir is passed to Fragment",s instanceof q),l("withDir and oppDir have the same parent",e.parent===(null==s?void 0:s.parent)),this.ends[r]=e,this.ends[r===i?1:i]=s;const o=this.fold([],((t,e)=>(t.push(...e.jQ.get()),t)));this.jQ=this.jQ.add(o)}withDirAdopt(t,e,s,r){return t===i?this.adopt(e,s,r):this.adopt(e,r,s)}adopt(t,e,s){h(t,e,s),this.disowned=!1;const r=this.ends[i];if(!r)return this;const n=this.ends[1];return e||(t.ends[i]=r),s?s[i]=n:t.ends[1]=n,this.ends[1][1]=s,this.each((s=>{s[i]=e,s.parent=t,e&&(e[1]=s),e=s})),this}disown(){const t=this.ends[i];if(!t||this.disowned)return this;this.disowned=!0;const e=this.ends[1],s=t.parent;return h(s,t[i],t),h(s,e,null==e?void 0:e[1]),t[i]?t[i][1]=null==e?void 0:e[1]:s.ends[i]=null==e?void 0:e[1],(null==e?void 0:e[1])?e[1][i]=t[i]:s.ends[1]=t[i],this}remove(){return this.jQ.remove(),this.each("postOrder","dispose"),this.disown()}fold(t,e){let s=t;return this.each((t=>{s=e(s,t)})),s}}class x extends b{constructor(t,e,s=i){super(t,e,s),this.jQ=this.jQ.wrapAll('<span class="mq-selection"></span>').parent()}adopt(t,e,s){return this.jQ.replaceWith(this.jQ=this.jQ.children()),super.adopt(t,e,s)}clear(){return this.jQ.replaceWith(this.jQ[0].childNodes),this}join(t){return this.fold("",((e,s)=>e+s[t]()))}}const w=()=>l("overridden or never called on this node");class q{constructor(){this.jQ=t(),this.ends={},this.ctrlSeq="",this.bubble=n((t=>{for(let e=this;e&&!1!==t(e);e=e.parent);return this})),this.postOrder=n((t=>(function e(s){s.eachChild(e),t(s)}(this),this))),this.id=q.uniqueNodeId(),q.byId[this.id]=this}dispose(){delete q.byId[this.id]}toString(){return`{{ MathQuill Node #${this.id} }}`}jQadd(t){this.jQ=this.jQ.add(t)}jQize(i){const r=t(i||this.html()),n=t=>{var i,r;if(t.getAttribute){const n=parseInt(null!==(i=t.getAttribute(e))&&void 0!==i?i:"0"),o=parseInt(null!==(r=t.getAttribute(s))&&void 0!==r?r:"0");n&&q.byId[n].jQadd(t),o&&q.byId[o].jQadd(t)}for(let e=t.firstChild;e;e=e.nextSibling)n(e)};return r.each(((t,e)=>n(e))),r}createDir(t,e){return a(t),this.jQize(),this.jQ.insDirOf(t,e.jQ),e[t]=this.adopt(e.parent,e[i],e[1]),this}createLeftOf(t){this.createDir(i,t)}selectChildren(t,e){return new x(t,e)}isEmpty(){return!this.ends[i]&&!this.ends[1]}isStyleBlock(){return!1}children(){return new b(this.ends[i],this.ends[1])}eachChild(t,e){return this.children().each(t,e),this}foldChildren(t,e){return this.children().fold(t,e)}withDirAdopt(t,e,s,i){return new b(this,this).withDirAdopt(t,e,s,i),this}adopt(t,e,s){return new b(this,this).adopt(t,e,s),this}disown(){return new b(this,this).disown(),this}remove(){return this.jQ.remove(),this.postOrder("dispose"),this.disown()}keystroke(t,e,s){const r=s.cursor;switch(t){case"Ctrl-Shift-Backspace":case"Ctrl-Backspace":s.ctrlDeleteDir(i);break;case"Shift-Backspace":case"Backspace":s.backspace();break;case"Esc":case"Tab":return void s.escapeDir(1,t,e);case"Shift-Tab":case"Shift-Esc":return void s.escapeDir(i,t,e);case"End":s.notify("move").cursor.insAtRightEnd(r.parent);break;case"Ctrl-End":s.notify("move").cursor.insAtRightEnd(s.root);break;case"Shift-End":for(;r[1];)s.selectRight();break;case"Ctrl-Shift-End":for(;r[1]||r.parent!==s.root;)s.selectRight();break;case"Home":s.notify("move").cursor.insAtLeftEnd(r.parent);break;case"Ctrl-Home":s.notify("move").cursor.insAtLeftEnd(s.root);break;case"Shift-Home":for(;r[i];)s.selectLeft();break;case"Ctrl-Shift-Home":for(;r[i]||r.parent!==s.root;)s.selectLeft();break;case"Left":s.moveLeft();break;case"Shift-Left":s.selectLeft();break;case"Ctrl-Left":case"Ctrl-Right":case"Ctrl-Up":case"Ctrl-Down":break;case"Right":s.moveRight();break;case"Shift-Right":s.selectRight();break;case"Up":s.moveUp();break;case"Down":s.moveDown();break;case"Shift-Up":if(r[i])for(;r[i];)s.selectLeft();else s.selectLeft();break;case"Shift-Down":if(r[1])for(;r[1];)s.selectRight();else s.selectRight();break;case"Ctrl-Shift-Del":case"Ctrl-Del":s.ctrlDeleteDir(1);break;case"Shift-Del":case"Del":s.deleteForward();break;case"Meta-A":case"Ctrl-A":for(s.notify("move").cursor.insAtRightEnd(s.root);r[i];)s.selectLeft();break;default:return}e.preventDefault(),s.scrollHoriz()}html(){return""}text(){return""}latex(){return""}focus(){}blur(t){}seek(t,e){}writeLatex(t,e){}finalizeInsert(t,e){}write(t,e){}replaces(t){}setOptions(t){return this}chToCmd(t,e){return this}moveOutOf(t,e,s){w()}moveTowards(t,e,s){w()}deleteOutOf(t,e){w()}deleteTowards(t,e){w()}unselectInto(t,e){w()}selectOutOf(t,e){w()}selectTowards(t,e){w()}}q.id=0,q.byId={},q.uniqueNodeId=()=>++q.id;class O{constructor(t,e,s){this.parent=t,this[i]=e,this[1]=s}static copy(t){return new O(t.parent,t[i],t[1])}}const y=t=>{t.moveOutOf=e=>{var s;return null===(s=t.controller)||void 0===s?void 0:s.handle("moveOutOf",e)},t.deleteOutOf=e=>{var s;return null===(s=t.controller)||void 0===s?void 0:s.handle("deleteOutOf",e)},t.selectOutOf=e=>{var s;return null===(s=t.controller)||void 0===s?void 0:s.handle("selectOutOf",e)},t.upOutOf=e=>{var s;return null===(s=t.controller)||void 0===s?void 0:s.handle("upOutOf",e)},t.downOutOf=e=>{var s;return null===(s=t.controller)||void 0===s?void 0:s.handle("downOutOf",e)},t.reflow=()=>{var e,s,i;null===(e=t.controller)||void 0===e||e.handle("reflow"),null===(s=t.controller)||void 0===s||s.handle("edited"),null===(i=t.controller)||void 0===i||i.handle("edit")}},S=t=>class extends t{moveTowards(t,e,s){const r=s&&this[`${s}Into`];e.insAtDirEnd(t===i?1:i,r||this.ends[t===i?1:i])}deleteTowards(t,e){this.isEmpty()?e[t]=this.remove()[t]:this.moveTowards(t,e)}selectTowards(t,e){e[t===i?1:i]=this,e[t]=this[t]}},k=document.createElement("div").style,_={transform:1,WebkitTransform:1,MozTransform:1,OTransform:1,msTransform:1};let j="";for(const t in _)if(t in k){j=t;break}const C=j?(t,e,s)=>t.css(j,`scale(${e},${s})`):(t,e,s)=>t.css("fontSize",`${s}em`),Q=t=>class extends t{constructor(){super(...arguments),this.reflow=()=>{var t,e,s,i;const r=(null!==(e=null===(t=this.contentjQ)||void 0===t?void 0:t.outerHeight())&&void 0!==e?e:0)/parseFloat(null!==(i=null===(s=this.contentjQ)||void 0===s?void 0:s.css("fontSize"))&&void 0!==i?i:"1");C(this.delimjQs,Math.min(1+.2*(r-1),1.2),1.2*r)}}jQadd(t){super.jQadd(t),this.delimjQs=this.jQ.children(":first").add(this.jQ.children(":last")),this.contentjQ=this.jQ.children(":eq(1)")}};class T{constructor(t){this._=t}parse(t){return this.skip(T.eof)._(`${t}`,((t,e)=>e),((t,e)=>{throw`Parse Error: ${e} at ${t||"EOF"}`}))}or(t){return l("or is passed a parser",t instanceof T),new T(((e,s,i)=>this._(e,s,(()=>t._(e,s,i)))))}then(t){return new T(((e,s,i)=>this._(e,((e,r)=>{const n=t instanceof T?t:"function"==typeof t?t(r):void 0;return l("a parser is returned",n instanceof T),n._(e,s,i)}),i)))}many(){return new T(((t,e)=>{const s=[];for(;this._(t,((e,i)=>(t=e,s.push(i),!0)),(()=>!1)););return e(t,s)}))}times(t,e=t){return new T(((s,i,r)=>{const n=[];let o=!0;for(let i=0;i<e&&o;++i){let e;if(o=this._(s,((t,e)=>(n.push(e),s=t,!0)),((t,i)=>(e=i,s=t,!1))),i<t&&!o)return r(s,e)}return i(s,n)}))}result(t){return this.then(T.succeed(t))}atMost(t){return this.times(0,t)}atLeast(t){return this.times(t).then((t=>this.many().map((e=>t.concat(e)))))}map(t){return this.then((e=>"function"==typeof t&&/^\s*class\s+/.test(t.toString())?T.succeed(new t(e)):"function"==typeof t?T.succeed(t(e)):T.fail("Invalid map function")))}skip(t){return this.then((e=>t.result(e)))}static string(t){return new T(((e,s,i)=>{const r=e.slice(0,t.length);return r===t?s(e.slice(t.length),r):i(e,`expected '${t}'`)}))}static regex(t){return l("regexp parser is anchored","^"===t.toString().charAt(1)),new T(((e,s,i)=>{const r=t.exec(e);return r?s(e.slice(r[0].length),r[0]):i(e,`expected ${t.toString()}`)}))}static succeed(t){return new T(((e,s)=>s(e,t)))}static fail(t){return new T(((e,s,i)=>i(e,t)))}}T.letter=T.regex(/^[a-z]/i),T.letters=T.regex(/^[a-z]*/i),T.digit=T.regex(/^[0-9]/),T.digits=T.regex(/^[0-9]*/),T.whitespace=T.regex(/^\s+/),T.optWhitespace=T.regex(/^\s*/),T.any=new T(((t,e,s)=>t?e(t.slice(1),t.charAt(0)):s(t,"expected any character"))),T.all=new T(((t,e)=>e("",t))),T.eof=new T(((t,e,s)=>t?s(t,"expected EOF"):e(t,t)));const D=t=>class extends t{focusBlurEvents(){var t,e;null===(t=this.textarea)||void 0===t||t.focus((()=>{var t;this.blurred=!1,this.container.addClass("mq-focused"),this.cursor.parent||this.cursor.insAtRightEnd(this.root),this.cursor.selection?(this.cursor.selection.jQ.removeClass("mq-blur"),null===(t=this.selectionChanged)||void 0===t||t.call(this)):this.cursor.show()})).blur((()=>{var t;this.blurred=!0,this.container.removeClass("mq-focused"),null===(t=this.cursor.hide().parent)||void 0===t||t.blur(),this.cursor.selection&&this.cursor.selection.jQ.addClass("mq-blur")})),this.blurred=!0,null===(e=this.cursor.hide().parent)||void 0===e||e.blur()}unbindFocusBlurEvents(){var t;null===(t=this.textarea)||void 0===t||t.off("focus blur")}},E=t=>class extends t{focus(){this.jQ.addClass("mq-hasCursor"),this.jQ.removeClass("mq-empty")}blur(){this.jQ.removeClass("mq-hasCursor"),this.isEmpty()&&this.jQ.addClass("mq-empty")}};class $ extends q{finalizeInsert(t,e){var s,r,n,o;this.postOrder("finalizeTree",t),this.postOrder("contactWeld",e),this.postOrder("blur"),this.postOrder("reflow"),null===(r=null===(s=this[1])||void 0===s?void 0:s.siblingCreated)||void 0===r||r.call(s,t,i),null===(o=null===(n=this[i])||void 0===n?void 0:n.siblingCreated)||void 0===o||o.call(n,t,1),this.bubble("reflow")}prepareInsertionAt(t){const e=t.options.maxDepth;if(void 0!==e){const s=t.depth();if(s>e)return!1;this.removeNodesDeeperThan(e-s)}return!0}removeNodesDeeperThan(t){var e;let s=0;const i=[[this,s]];for(;i.length;){const r=i.shift();null===(e=null==r?void 0:r[0].children())||void 0===e||e.each((e=>{const n=e instanceof Z?1:0;s=r[1]+n,s<=t?i.push([e,s]):(n?e.children():e).remove()}))}}}class L extends(S($)){constructor(t,e,s){super(),this.blocks=[],this.ctrlSeq=null!=t?t:"",this.htmlTemplate=null!=e?e:"",this.textTemplate=null!=s?s:[""]}replaces(t){null==t||t.disown(),this.replacedFragment=t}isEmpty(){return this.foldChildren(!0,((t,e)=>t&&e.isEmpty()))}parser(){return G.block.times(this.numBlocks()).map((t=>{this.blocks=t;for(const e of t)e.adopt(this,this.ends[1]);return this}))}createLeftOf(t){var e;const s=this.replacedFragment;this.createBlocks(),super.createLeftOf(t),s&&(s.adopt(this.ends[i]),s.jQ.appendTo(null===(e=this.ends[i])||void 0===e?void 0:e.jQ),this.placeCursor(t),this.prepareInsertionAt(t)),this.finalizeInsert(t.options),this.placeCursor(t)}createBlocks(){const t=this.numBlocks();this.blocks=Array(t);for(let e=0;e<t;++e)this.blocks[e]=new Z,this.blocks[e].adopt(this,this.ends[1])}placeCursor(t){t.insAtRightEnd(this.foldChildren(this.ends[i],((t,e)=>t.isEmpty()?t:e)))}selectChildren(){return new x(this,this)}unselectInto(t,e){var s,r;e.insAtDirEnd(t===i?1:i,null===(r=null===(s=e.anticursor)||void 0===s?void 0:s.ancestors)||void 0===r?void 0:r[this.id])}seek(t,e){const s=t=>{var e,s,r,n;const o={[i]:0,1:0};return o[i]=null!==(s=null===(e=t.jQ.offset())||void 0===e?void 0:e.left)&&void 0!==s?s:0,o[1]=(null!==(r=o[i])&&void 0!==r?r:0)+(null!==(n=t.jQ.outerWidth())&&void 0!==n?n:0),o},r=s(this);if(t<r[i])return void e.insLeftOf(this);if(t>r[1])return void e.insRightOf(this);let n=r[i];this.eachChild((o=>{const l=s(o);return t<l[i]?(t-n<l[i]-t?o[i]?e.insAtRightEnd(o[i]):e.insLeftOf(this):e.insAtLeftEnd(o),!1):t>l[1]?void(o[1]?n=l[1]:r[1]-t<t-l[1]?e.insRightOf(this):e.insAtRightEnd(o)):(o.seek(t,e),!1)}))}numBlocks(){const t=this.htmlTemplate.match(/&\d+/g);return t?t.length:0}html(){const t=this.blocks,i=` ${e}=${this.id}`,r=this.htmlTemplate.match(/<[^<>]+>|[^<>]+/g);l("no unmatched angle brackets",r.join("")===this.htmlTemplate);for(let t=0,e=r[0];e;++t,e=r[t])if("/>"===e.slice(-2))r[t]=`${e.slice(0,-2)}${i}/>`;else if("<"===e.charAt(0)){l("not an unmatched top-level close tag","/"!==e.charAt(1)),r[t]=`${e.slice(0,-1)}${i}>`;let s=1;do{t+=1,e=r[t],l("no missing close tags",!!e),"</"===e.slice(0,2)?s-=1:"<"===e.charAt(0)&&"/>"!==e.slice(-2)&&(s+=1)}while(s>0)}return r.join("").replace(/>&(\d+)/g,((e,i)=>{var r,n,o,l;return` ${s}=${null!==(n=null===(r=t[i])||void 0===r?void 0:r.id)&&void 0!==n?n:""}>${null!==(l=null===(o=t[i])||void 0===o?void 0:o.join("html"))&&void 0!==l?l:""}`}))}latex(){return this.foldChildren(this.ctrlSeq,((t,e)=>`${t}{${e.latex()||" "}}`))}text(){let t=0;return this.foldChildren(this.textTemplate[t],((e,s)=>{++t;const i=s.text();return e&&"("===this.textTemplate[t]&&"("===i[0]&&")"===i.slice(-1)?e+i.slice(1,-1)+this.textTemplate[t]:e+i+(this.textTemplate[t]||"")}))}}class A extends L{constructor(t,e,s){const i=s||(t&&t.length>1?t.slice(1):null!=t?t:"");super(t,e,[i]),this.createBlocks=r,this.isSymbol=!0}parser(){return T.succeed(this)}numBlocks(){return 0}replaces(t){null==t||t.remove()}moveTowards(t,e){e.jQ.insDirOf(t,this.jQ),e[t===i?1:i]=this,e[t]=this[t]}deleteTowards(t,e){e[t]=this.remove()[t]}seek(t,e){var s,i,r;t-(null!==(i=null===(s=this.jQ.offset())||void 0===s?void 0:s.left)&&void 0!==i?i:0)<(null!==(r=this.jQ.outerWidth())&&void 0!==r?r:0)/2?e.insLeftOf(this):e.insRightOf(this)}latex(){return this.ctrlSeq}text(){return this.textTemplate.join("")}placeCursor(){}isEmpty(){return!0}}class R extends A{constructor(t,e,s){super(t,`<span>${e||t}</span>`,s)}}class I extends A{constructor(t,e,s,i=!1){super(t,!0===i?e:`<span class="mq-binary-operator">${null!=e?e:""}</span>`,s),this.isUnary=!1}}class B extends I{constructor(t,e){const s=e?"Strict":"";super(t[`ctrlSeq${s}`],t[`html${s}`],t[`text${s}`]),this.data=t,this.strict=e}swap(t){this.strict=t;const e=t?"Strict":"";this.ctrlSeq=this.data[`ctrlSeq${e}`],this.jQ.html(this.data[`html${e}`]),this.textTemplate=[this.data[`text${e}`]]}deleteTowards(t,e){if(t===i&&!this.strict)return this.swap(!0),void this.bubble("reflow");super.deleteTowards(t,e)}}class z extends I{constructor(){super("=","=")}createLeftOf(t){var e;if(t[i]instanceof B&&t[i].strict)return t[i].swap(!1),void(null===(e=t[i])||void 0===e||e.bubble("reflow"));super.createLeftOf(t)}}class F extends R{createLeftOf(t){var e,s,r,n,o;t.options.autoSubscriptNumerals&&t.parent!==(null===(s=null===(e=t.parent)||void 0===e?void 0:e.parent)||void 0===s?void 0:s.sub)&&(t[i]instanceof M&&!1!==t[i].isItalic||t[i]instanceof U&&(null===(r=t[i])||void 0===r?void 0:r[i])instanceof M&&!1!==(null===(n=t[i])||void 0===n?void 0:n[i]).isItalic)?((new c._).createLeftOf(t),super.createLeftOf(t),t.insRightOf(null===(o=t.parent)||void 0===o?void 0:o.parent)):super.createLeftOf(t)}}class M extends A{constructor(t,e){super(t,`<var>${e||t}</var>`),this.isItalic=!1,this.isPartOfOperator=!1}text(){let t=this.ctrlSeq;return this.isPartOfOperator&&("\\"==t[0]?t=t.startsWith("\\operatorname{")?t.slice(14,t.length):t.slice(1,t.length):" "!=t[t.length-1]&&"}"!=t[t.length-1]||(t=t.slice(0,-1),this[1]instanceof V||this[1]instanceof P||(t+=" "))),t}}class N extends M{constructor(t,e){super(t,e),this.letter=t,this.siblingDeleted=this.siblingCreated=(t,e)=>this.finalizeTree(t,e)}createLeftOf(t){super.createLeftOf(t);const e=t.options.autoCommands,s=e._maxLength;if(s>0){let r="",n=this,o=0;for(;n instanceof N&&(null==n?void 0:n.ctrlSeq)===(null==n?void 0:n.letter)&&o<s;)r=n.letter+r,n=n[i],++o;for(;r.length;){if(e[r]){for(o=1,n=this;o<r.length;++o,n=null==n?void 0:n[i]);return new b(n,this).remove(),t[i]=null==n?void 0:n[i],new c[r](r).createLeftOf(t)}r=r.slice(1)}}}italicize(t){return this.isItalic=t,this.isPartOfOperator=!t,this.jQ.toggleClass("mq-operator-name",!t),this}finalizeTree(t,e){e!==i&&this[1]instanceof N||this.autoUnItalicize(t)}autoUnItalicize(t){var e,s,r,n,o,l,a;const h=t.autoOperatorNames;if(0===h._maxLength)return;let c=this.letter,d=this[i],u=this[1];for(;d instanceof N;d=d[i])c=d.letter+c;for(;u instanceof N;u=u[1])c+=u.letter;new b((null==d?void 0:d[1])||(null===(e=this.parent)||void 0===e?void 0:e.ends[i]),(null==u?void 0:u[i])||(null===(s=this.parent)||void 0===s?void 0:s.ends[1])).each((t=>{t.italicize(!0).jQ.removeClass("mq-first mq-last mq-followed-by-supsub"),t.ctrlSeq=t.letter}));for(let e=0,s=(null==d?void 0:d[1])||(null===(r=this.parent)||void 0===r?void 0:r.ends[i]);e<c.length;++e,s=null==s?void 0:s[1])for(let r=Math.min(h._maxLength,c.length-e);r>0;--r){const d=c.slice(e,e+r);if(h[d]){let h;for(let t=0,e=s;t<r;t+=1,e=null==e?void 0:e[1])e.italicize(!1),h=e;const c=f[d];if(s.ctrlSeq=(c?"\\":"\\operatorname{")+(null!==(n=null==s?void 0:s.ctrlSeq)&&void 0!==n?n:""),h.ctrlSeq+=c?" ":"}",d in m&&(null===(a=null===(l=null===(o=null==h?void 0:h[i])||void 0===o?void 0:o[i])||void 0===l?void 0:l[i])||void 0===a||a.jQ.addClass("mq-last")),this.shouldOmitPadding(null==s?void 0:s[i])||null==s||s.jQ.addClass("mq-first"),!this.shouldOmitPadding(null==h?void 0:h[1]))if((null==h?void 0:h[1])instanceof U){const e=h[1];e.siblingCreated=e.siblingDeleted=()=>{e.jQ.toggleClass("mq-after-operator-name",!(e[1]instanceof V))},e.siblingCreated(t)}else null==h||h.jQ.toggleClass("mq-last",!((null==h?void 0:h[1])instanceof V));e+=r-1,s=h;break}}}shouldOmitPadding(t){return!t||t instanceof I||t instanceof H}}function W(t){var e;const s=this.parent;let i=t;do{if(null==i?void 0:i[1])return t.insLeftOf(s);i=null===(e=null==i?void 0:i.parent)||void 0===e?void 0:e.parent}while(i!==s);t.insRightOf(s)}class P extends L{constructor(){super(),this.ctrlSeq="\\frac",this.htmlTemplate='<span class="mq-fraction mq-non-leaf"><span class="mq-numerator">&0</span><span class="mq-denominator">&1</span><span style="display:inline-block;width:0">&#8203;</span></span>',this.textTemplate=["((",")/(","))"]}text(){var t;let e=this[i];for(;e&&"\\ "===e.ctrlSeq;e=e[i]);const s=t=>{var e,s,r;let n=!1,o=0,l=!1;null===(e=this.ends[t])||void 0===e||e.eachChild((t=>(t instanceof F&&(l=!0),t instanceof F||t instanceof I&&t.isUnary||t instanceof U||++o,(l&&o||o>1||t instanceof I&&!t.isUnary||"text"in c&&t instanceof c.text||t instanceof H||t instanceof P||"\\ "===t.ctrlSeq||/^[,;:]$/.test(t.ctrlSeq))&&(n=!0),!n)));const a=t===i?0:1,h=" "!==(null===(s=this.ends[t])||void 0===s?void 0:s.text())&&(null===(r=this.ends[t])||void 0===r?void 0:r.text());return h?n?`(${h})`:h:a};return e instanceof I&&e.isUnary||(null==e?void 0:e.jQ.hasClass("mq-operator-name"))||e instanceof U&&(null===(t=e[i])||void 0===t?void 0:t.jQ.hasClass("mq-operator-name"))?`(${s(i)}/${s(1)})`:` ${s(i)}/${s(1)} `}finalizeTree(){this.upInto=this.ends[1].upOutOf=this.ends[i],this.downInto=this.ends[i].downOutOf=this.ends[1]}}class U extends L{constructor(t,e,s){super("_{...}^{...}",e,s),this.supsub="sup",this.reflow=()=>{var t,e,s,i,r;const n=this.jQ,o=n.prev();if(!o.length)return;const l=n.children(".mq-sup");if(l.length){const n=parseInt(l.css("font-size")),a=(null!==(e=null===(t=null==l?void 0:l.offset())||void 0===t?void 0:t.top)&&void 0!==e?e:0)+(null!==(s=null==l?void 0:l.height())&&void 0!==s?s:0)-(null!==(r=null===(i=o.offset())||void 0===i?void 0:i.top)&&void 0!==r?r:0)-.7*n,h=parseInt(l.css("margin-bottom"));l.css("margin-bottom",h+a)}}}hasValidBase(t){var e,s,r;return!(t.options.supSubsRequireOperand&&(!t[i]||"\\ "===(null===(e=t[i])||void 0===e?void 0:e.ctrlSeq)||t[i]instanceof I||/^[,;:]$/.test(null!==(r=null===(s=t[i])||void 0===s?void 0:s.ctrlSeq)&&void 0!==r?r:"")))}createLeftOf(t){if(this.hasValidBase(t)){if(t[i]instanceof P){const e=new V(1,"(",")","(",")");t.selection=t[i].selectChildren(),e.replaces(t.replaceSelection()),e.createLeftOf(t)}super.createLeftOf(t)}else this.replacedFragment&&(this.replacedFragment.adopt(t.parent,t[i],t[1]),t[i]=this.replacedFragment.ends[1])}contactWeld(t){var e,s;for(const e of[i,1])if(this[e]instanceof U){let s;for(const t of["sub","sup"]){const r=this[t],n=this[e][t];if(r){if(n)if(r.isEmpty())s=new O(n,void 0,n.ends[i]);else{r.jQ.children().insAtDirEnd(e===i?1:i,n.jQ);const t=r.children().disown();s=new O(n,t.ends[1],n.ends[i]),e===i?t.adopt(n,n.ends[1]):t.adopt(n,void 0,n.ends[i])}else this[e].addBlock(r.disown());this.placeCursor=t=>t.insAtDirEnd(e===i?1:i,n||r)}}return this.remove(),void(t&&(t[i]===this?1===e&&s?s[i]?t.insRightOf(s[i]):t.insAtLeftEnd(s.parent):t.insRightOf(this[e]):(null==s?void 0:s[1])&&t.insRightOf(s[1])))}if(t&&t[1]===this&&(!this.hasValidBase(t)||t[i]instanceof P)){for(const r of["sub","sup"]){const n=this[r];n&&(n.children().disown().adopt(t.parent,t[i],t[1]).jQ.insDirOf(1,t.jQ),(null===(e=t[i])||void 0===e?void 0:e[1])?t.insLeftOf(null===(s=t[i])||void 0===s?void 0:s[1]):t.insAtDirEnd(i,t.parent))}this.remove()}}finalizeTree(){this.ends[i].isSupSubLeft=!0}moveTowards(t,e,s){e.options.autoSubscriptNumerals&&!this.sup?e.insDirOf(t,this):super.moveTowards(t,e,s)}deleteTowards(t,e){if(e.options.autoSubscriptNumerals&&this.sub){const s=this.sub.ends[t===i?1:i];s instanceof A?s.remove():s&&s.deleteTowards(t,e.insAtDirEnd(t===i?1:i,this.sub)),this.sub.isEmpty()&&(this.sub.deleteOutOf(i,e.insAtLeftEnd(this.sub)),this.sup&&e.insDirOf(t===i?1:i,this))}else super.deleteTowards(t,e)}latex(){const t=(t,e)=>{const s=e&&e.latex();return e?t+(1===(null==s?void 0:s.length)?s:`{${s||" "}}`):""};return t("_",this.sub)+t("^",this.sup)}text(){const t=(t,e)=>{let s=!1,i=0,r=!1;null==e||e.eachChild((t=>(t instanceof F&&(r=!0),t instanceof F||t instanceof I&&t.isUnary||++i,(r&&i||i>1||t instanceof I&&!t.isUnary||"text"in c&&t instanceof c.text||t instanceof H||t instanceof P||"\\ "===t.ctrlSeq||/^[,;:]$/.test(t.ctrlSeq))&&(s=!0),!s)));const n=" "!==(null==e?void 0:e.text())&&(null==e?void 0:e.text());return n?t+(s?`(${n})`:n):""},e=t("_",this.sub)+t("^",this.sup);return e+(e&&this[1]instanceof F?" ":"")}addBlock(e){"sub"===this.supsub?(this.sup=this.upInto=this.sub.upOutOf=e,e.adopt(this,this.sub).downOutOf=this.sub,e.jQ=t('<span class="mq-sup"/>').append(e.jQ.children()).attr(s,e.id).prependTo(this.jQ)):(this.sub=this.downInto=this.sup.downOutOf=e,e.adopt(this,void 0,this.sup).upOutOf=this.sup,e.jQ=t('<span class="mq-sub"></span>').append(e.jQ.children()).attr(s,e.id).appendTo(this.jQ.removeClass("mq-sup-only")),this.jQ.append('<span style="display:inline-block;width:0">&#8203;</span>'));for(const e of["sub","sup"]){const s="sub"===e?"sup":"sub",r="sub"===e?"down":"up",n=this[e];n.deleteOutOf=(o,l)=>{if(l.insDirOf(n[o]?o===i?1:i:o,n.parent),!n.isEmpty()){const t=n.ends[o];n.children().disown().withDirAdopt(o,l.parent,l[o],l[o===i?1:i]).jQ.insDirOf(o===i?1:i,l.jQ),l[o===i?1:i]=t}this.supsub=s,delete this[e],delete this[`${r}Into`],this[s][`${r}OutOf`]=W,delete this[s].deleteOutOf,"sub"===e&&t(this.jQ.addClass("mq-sup-only")[0].lastChild).remove(),n.remove()}}}}class H extends L{latex(){var t,e,s,r;const n=t=>1===t.length?t:`{${t||" "}}`;return`${this.ctrlSeq}_${n(null!==(e=null===(t=this.ends[i])||void 0===t?void 0:t.latex())&&void 0!==e?e:"")}^${n(null!==(r=null===(s=this.ends[1])||void 0===s?void 0:s.latex())&&void 0!==r?r:"")}`}text(){var t,e,s,r;return`${this.ctrlSeq.slice(1,this.ctrlSeq.length-1)}(${null!==(e=null===(t=this.ends[i])||void 0===t?void 0:t.text())&&void 0!==e?e:""},${null!==(r=null===(s=this.ends[1])||void 0===s?void 0:s.text())&&void 0!==r?r:""})`}parser(){const t=this.blocks=[new Z,new Z];for(const e of t)e.adopt(this,this.ends[1]);return T.optWhitespace.then(T.string("_").or(T.string("^"))).then((e=>{const s=t["_"===e?0:1];return G.block.then((t=>(t.children().adopt(s,s.ends[1]),T.succeed(this))))})).many().result(this)}finalizeTree(){this.downInto=this.ends[i],this.upInto=this.ends[1],this.ends[i].upOutOf=this.ends[1],this.ends[1].downOutOf=this.ends[i]}}class V extends(Q(L)){constructor(t,e,s,n,o){super(`\\left${n}`,void 0,[e,s]),this.side=t,this.sides={[i]:{ch:e,ctrlSeq:n},1:{ch:s,ctrlSeq:o}},this.placeCursor=r,this.siblingCreated=(t,e)=>{e===(this.side===i?1:i)&&this.finalizeTree()}}numBlocks(){return 1}html(){return this.htmlTemplate=`<span class="mq-non-leaf"><span class="mq-scaled mq-paren${1===this.side?" mq-ghost":""}">`+this.sides[i].ch+'</span><span class="mq-non-leaf">&0</span>'+`<span class="mq-scaled mq-paren${this.side===i?" mq-ghost":""}">`+this.sides[1].ch+"</span></span>",super.html()}latex(){var t,e,s,r,n,o;return`\\left${null!==(e=null===(t=this.sides[i])||void 0===t?void 0:t.ctrlSeq)&&void 0!==e?e:""}${null!==(r=null===(s=this.ends[i])||void 0===s?void 0:s.latex())&&void 0!==r?r:""}\\right${null!==(o=null===(n=this.sides[1])||void 0===n?void 0:n.ctrlSeq)&&void 0!==o?o:""}`}text(){var t,e,s,r,n,o;return`${null!==(e=null===(t=this.sides[i])||void 0===t?void 0:t.ch)&&void 0!==e?e:""}${null!==(r=null===(s=this.ends[i])||void 0===s?void 0:s.text())&&void 0!==r?r:""}${null!==(o=null===(n=this.sides[1])||void 0===n?void 0:n.ch)&&void 0!==o?o:""}`}matchBrack(t,e,s){return s instanceof V&&s.side&&s.side!==(e===i?1:1===e?i:void 0)&&(!t.restrictMismatchedBrackets||u[this.sides[this.side].ch]===s.sides[s.side].ch||{"(":"]","[":")"}[this.sides[i].ch]===s.sides[1].ch)&&s}closeOpposing(t){var e;t.side=0,t.sides[this.side]=this.sides[this.side],null===(e=t.delimjQs)||void 0===e||e.eq(this.side===i?0:1).removeClass("mq-ghost").html(this.sides[this.side].ch)}createLeftOf(t){var e,s,r,n,o;let l,a;if(!this.replacedFragment){const r=t.options;if("|"===this.sides[i].ch)l=this.matchBrack(r,1,t[1])||this.matchBrack(r,i,t[i])||this.matchBrack(r,void 0,null===(e=t.parent)||void 0===e?void 0:e.parent);else{const e=this.side===i?1:i;l=this.matchBrack(r,e,t[e])||this.matchBrack(r,e,null===(s=t.parent)||void 0===s?void 0:s.parent)}}l?(a=this.side=l.side===i?1:i,this.closeOpposing(l),l===(null===(r=t.parent)||void 0===r?void 0:r.parent)&&t[a]&&new b(t[a],null===(n=t.parent)||void 0===n?void 0:n.ends[a],a===i?1:i).disown().withDirAdopt(a===i?1:i,l.parent,l,l[a]).jQ.insDirOf(a,l.jQ),l.bubble("reflow")):(l=this,a=l.side,l.replacedFragment?l.side=0:t[a===i?1:i]&&(l.replaces(new b(t[a===i?1:i],null===(o=t.parent)||void 0===o?void 0:o.ends[a===i?1:i],a)),delete t[a===i?1:i]),super.createLeftOf(t)),a===i?t.insAtLeftEnd(l.ends[i]):t.insRightOf(l)}unwrap(){var t;null===(t=this.ends[i])||void 0===t||t.children().disown().adopt(this.parent,this,this[1]).jQ.insertAfter(this.jQ),this.remove()}deleteSide(t,e,s){var r,n,o,l,a,h,c,d,p,f,m;const v=this.parent,g=this[t],x=v.ends[t];if(t===this.side)return this.unwrap(),void(g?s.insDirOf(t===i?1:i,g):s.insAtDirEnd(t,v));const w=!this.side;if(this.side=t===i?1:i,this.matchBrack(s.options,t,null===(r=this.ends[i])||void 0===r?void 0:r.ends[this.side])){this.closeOpposing(null===(n=this.ends[i])||void 0===n?void 0:n.ends[this.side]);const e=null===(o=this.ends[i])||void 0===o?void 0:o.ends[t];this.unwrap(),null===(l=null==e?void 0:e.siblingCreated)||void 0===l||l.call(e,s.options,t),g?s.insDirOf(t===i?1:i,g):s.insAtDirEnd(t,v)}else{if(this.matchBrack(s.options,t,null===(a=this.parent)||void 0===a?void 0:a.parent))(null===(h=this.parent)||void 0===h?void 0:h.parent).closeOpposing(this),(null===(c=this.parent)||void 0===c?void 0:c.parent).unwrap();else{if(e&&w)return this.unwrap(),void(g?s.insDirOf(t===i?1:i,g):s.insAtDirEnd(t,v));this.sides[t]={ch:u[this.sides[this.side].ch],ctrlSeq:u[this.sides[this.side].ctrlSeq]},null===(d=this.delimjQs)||void 0===d||d.removeClass("mq-ghost").eq(t===i?0:1).addClass("mq-ghost").html(this.sides[t].ch)}if(g){const e=null===(p=this.ends[i])||void 0===p?void 0:p.ends[t];new b(g,x,t===i?1:i).disown().withDirAdopt(t===i?1:i,this.ends[i],e).jQ.insAtDirEnd(t,null===(f=this.ends[i])||void 0===f?void 0:f.jQ.removeClass("mq-empty")),null===(m=null==e?void 0:e.siblingCreated)||void 0===m||m.call(e,s.options,t),s.insDirOf(t===i?1:i,g)}else e?s.insDirOf(t,this):s.insAtDirEnd(t,this.ends[i])}}deleteTowards(t,e){this.deleteSide(t===i?1:i,!1,e)}finalizeTree(){this.ends[i].deleteOutOf=(t,e)=>{var s;return(null===(s=this.ends[i])||void 0===s?void 0:s.parent).deleteSide(t,!0,e)},this.finalizeTree=()=>{var t;null===(t=this.delimjQs)||void 0===t||t.eq(this.side===i?1:0).removeClass("mq-ghost"),this.side=0}}}const G=(()=>{const t=t=>{const e=t[0]||new Z;for(const s of t.slice(1))s.children().adopt(e,e.ends[1]);return e},e=T.letter.map((t=>new N(t))),s=T.regex(/^\d/).map((t=>new F(t))),i=T.regex(/^[^${}\\_^]/).map((t=>new R(t))),r=T.regex(/^[^\\a-eg-zA-Z]/).or(T.string("\\").then(T.regex(/^[a-z]+/i).or(T.regex(/^\s+/).result(" ")).or(T.any))).then((t=>{const e=c[t];return e?new e(t).parser():T.fail(`unknown command: \\${t}`)})).or(e).or(s).or(i),n=T.string("{").then((()=>l)).skip(T.string("}")),o=T.optWhitespace.then(n.or(r.map((t=>{const e=new Z;return t.adopt(e),e})))),l=o.many().map(t).skip(T.optWhitespace),a=T.string("[").then(o.then((t=>"]"!==t.join("latex")?T.succeed(t):T.fail())).many().map(t).skip(T.optWhitespace)).skip(T.string("]")),h=l;return h.block=o,h.optBlock=a,h})(),K=t=>class extends t{chToCmd(t,e){const s=d[t]||c[t];return t.match(/^[a-eg-zA-Z]$/)?new N(t):/^\d$/.test(t)?new F(t):e&&e.typingSlashWritesDivisionSymbol&&"/"===t?new c["÷"](t):e&&e.typingAsteriskWritesTimesSymbol&&"*"===t?new c["×"](t):s?new s(t):new R(t)}write(t,e){var s;if(this.isSupSubLeft){if(t.options.autoSubscriptNumerals&&this===(null===(s=this.parent)||void 0===s?void 0:s.sub)){if("_"===e)return;const s=this.chToCmd(e,t.options);return s.isSymbol?t.deleteSelection():t.clearSelection().insRightOf(this.parent),void s.createLeftOf(t.show())}t[i]&&!t[1]&&!t.selection&&t.options.charsThatBreakOutOfSupSub.indexOf(e)>-1&&t.insRightOf(this.parent)}const r=this.chToCmd(e,t.options);t.selection&&r.replaces(t.replaceSelection()),t.isTooDeep()||r.createLeftOf(t.show())}};class Z extends(E(K($))){join(t){return this.foldChildren("",((e,s)=>e+s[t]()))}html(){return this.join("html")}latex(){return this.join("latex")}text(){var t,e;return this.ends[i]&&this.ends[i]===this.ends[1]?null!==(e=null===(t=this.ends[i])||void 0===t?void 0:t.text())&&void 0!==e?e:"":this.join("text")}keystroke(t,e,s){return s.options.spaceBehavesLikeTab&&s.cursor.depth()>1&&("Spacebar"===t||"Shift-Spacebar"===t)?(e.preventDefault(),void s.escapeDir("Shift-Spacebar"===t?i:1,t,e)):super.keystroke(t,e,s)}moveOutOf(t,e,s){var r;!(s&&(null===(r=this.parent)||void 0===r?void 0:r[`${s}Into`]))&&this[t]?e.insAtDirEnd(t===i?1:i,this[t]):e.insDirOf(t,this.parent)}selectOutOf(t,e){e.insDirOf(t,this.parent)}deleteOutOf(t,e){e.unwrapGramp()}seek(t,e){var s,r,n,o,l,a,h,c;let d=this.ends[1];if(!d||(null!==(r=null===(s=null==d?void 0:d.jQ.offset())||void 0===s?void 0:s.left)&&void 0!==r?r:0)+(null!==(n=null==d?void 0:d.jQ.outerWidth())&&void 0!==n?n:0)<t)e.insAtRightEnd(this);else if(t<(null!==(a=null===(l=null===(o=this.ends[i])||void 0===o?void 0:o.jQ.offset())||void 0===l?void 0:l.left)&&void 0!==a?a:0))e.insAtLeftEnd(this);else{for(;t<(null!==(c=null===(h=null==d?void 0:d.jQ.offset())||void 0===h?void 0:h.left)&&void 0!==c?c:0);)d=null==d?void 0:d[i];null==d||d.seek(t,e)}}writeLatex(t,e){var s,r,n,o,l,a,h;const c=T.all,d=T.eof,u=G.skip(d).or(c.result(!1)).parse(e);if(u&&!u.isEmpty()&&u.prepareInsertionAt(t)){u.children().adopt(t.parent,t[i],t[1]);u.jQize().insertBefore(t.jQ),t[i]=u.ends[1],u.finalizeInsert(t.options,t),null===(n=null===(r=null===(s=u.ends[1])||void 0===s?void 0:s[1])||void 0===r?void 0:r.siblingCreated)||void 0===n||n.call(r,t.options,i),null===(a=null===(l=null===(o=u.ends[i])||void 0===o?void 0:o[i])||void 0===l?void 0:l.siblingCreated)||void 0===a||a.call(l,t.options,1),null===(h=t.parent)||void 0===h||h.bubble("reflow")}}focus(){return super.focus(),this}blur(){return super.blur(),this}}class X extends Z{constructor(){super(),y(this)}}class J extends(K(L)){constructor(t){super("$"),this.cursor=t,this.htmlTemplate='<span class="mq-math-mode">&0</span>'}createBlocks(){super.createBlocks();const t=this.ends[i];t.write=(e,s)=>{var r;"$"!==s?this.write(e,s):t.isEmpty()?(e.insRightOf(t.parent),null===(r=t.parent)||void 0===r||r.deleteTowards(i,e),new R("\\$","$").createLeftOf(e.show())):e[1]?e[i]?this.write(e,s):e.insLeftOf(t.parent):e.insRightOf(t.parent)}}latex(){var t,e;return`$${null!==(e=null===(t=this.ends[i])||void 0===t?void 0:t.latex())&&void 0!==e?e:""}$`}}class Y extends O{constructor(e,s){super(e),this.upDownCache={},this.blink=()=>this.jQ.toggleClass("mq-blink"),this.options=s,this.jQ=t('<span class="mq-cursor">&#8203;</span>')}show(){var t,e;return this.jQ.removeClass("mq-blink"),this.jQ.show(),this.intervalId?clearInterval(this.intervalId):(this[1]?this.selection&&(null===(t=this.selection.ends[i])||void 0===t?void 0:t[i])===this[i]?this.jQ.insertBefore(this.selection.jQ):this.jQ.insertBefore(this[1].jQ.first()):this.jQ.appendTo(this.parent.jQ),null===(e=this.parent)||void 0===e||e.focus()),this.intervalId=setInterval(this.blink,500),this}hide(){return this.intervalId&&clearInterval(this.intervalId),delete this.intervalId,this.jQ.detach(),this.jQ.hide(),this}withDirInsertAt(t,e,s,r){const n=this.parent;this.parent=e,this[t]=s,this[t===i?1:i]=r,n!==e&&n.blur&&n.blur(this)}insDirOf(t,e){var s;return a(t),this.jQ.insDirOf(t,e.jQ),this.withDirInsertAt(t,e.parent,e[t],e),null===(s=this.parent)||void 0===s||s.jQ.addClass("mq-hasCursor"),this}insLeftOf(t){return this.insDirOf(i,t)}insRightOf(t){return this.insDirOf(1,t)}insAtDirEnd(t,e){return a(t),this.jQ.insAtDirEnd(t,e.jQ),this.withDirInsertAt(t,e,void 0,e.ends[t]),e.focus(),this}insAtLeftEnd(t){return this.insAtDirEnd(i,t)}insAtRightEnd(t){return this.insAtDirEnd(1,t)}jumpUpDown(t,e){var s,i;this.upDownCache[t.id]=O.copy(this);const r=this.upDownCache[e.id];r?r[1]?this.insLeftOf(r[1]):this.insAtRightEnd(r.parent):e.seek(null!==(i=null===(s=this.offset())||void 0===s?void 0:s.left)&&void 0!==i?i:0,this)}offset(){const t=this.jQ.removeClass("mq-cursor").offset();return this.jQ.addClass("mq-cursor"),t}unwrapGramp(){var t,e,s,r,n,o,l,a,h,c;const d=null===(t=this.parent)||void 0===t?void 0:t.parent,u=d.parent,p=d[1];let f=d[i];if(d.disown().eachChild((t=>{t.isEmpty()||(t.children().adopt(u,f,p).each((t=>{t.jQ.insertBefore(d.jQ.first())})),f=t.ends[1])})),!this[1])if(this[i])this[1]=null===(e=this[i])||void 0===e?void 0:e[1];else for(;!this[1];){if(this.parent=null===(s=this.parent)||void 0===s?void 0:s[1],!this.parent){this[1]=d[1],this.parent=u;break}this[1]=null===(r=this.parent)||void 0===r?void 0:r.ends[i]}this[1]?this.insLeftOf(this[1]):this.insAtRightEnd(u),d.jQ.remove(),(null===(n=d[i])||void 0===n?void 0:n.siblingDeleted)&&(null===(l=null===(o=d[i])||void 0===o?void 0:o.siblingDeleted)||void 0===l||l.call(o,this.options,1)),(null===(a=d[1])||void 0===a?void 0:a.siblingDeleted)&&(null===(c=null===(h=d[1])||void 0===h?void 0:h.siblingDeleted)||void 0===c||c.call(h,this.options,i))}startSelection(){this.anticursor=O.copy(this),this.anticursor.ancestors={};for(let t=this.anticursor;t.parent;t=t.parent)this.anticursor.ancestors[t.parent.id]=t}endSelection(){delete this.anticursor}select(){var t,e,s,r,n;if(this[i]===(null===(t=this.anticursor)||void 0===t?void 0:t[i])&&this.parent===(null===(e=this.anticursor)||void 0===e?void 0:e.parent))return!1;if(l("selection well formed",!!this.anticursor&&!!this.anticursor.ancestors),!this.anticursor||!this.anticursor.ancestors)return!1;let o=this,a=null;for(;o.parent;o=o.parent)if(o.parent.id in this.anticursor.ancestors){a=o.parent;break}l("cursor and anticursor in the same tree",!!a);const h=this.anticursor.ancestors[null!==(s=null==a?void 0:a.id)&&void 0!==s?s:0];let c,d,u=1;if(o[i]!==h)for(let t=o;t;t=t[1])if(t[1]===h[1]){u=i,c=o,d=h;break}return 1===u&&(c=h,d=o),c instanceof O&&(c=c[1]),d instanceof O&&(d=d[i]),this.hide().selection=null==a?void 0:a.selectChildren(c,d),this.insDirOf(u,null===(r=this.selection)||void 0===r?void 0:r.ends[u]),null===(n=this.selectionChanged)||void 0===n||n.call(this),!0}clearSelection(){var t;return this.selection&&(this.selection.clear(),delete this.selection,null===(t=this.selectionChanged)||void 0===t||t.call(this)),this}deleteSelection(){var t,e,s;this.selection&&(this[i]=null===(t=this.selection.ends[i])||void 0===t?void 0:t[i],this[1]=null===(e=this.selection.ends[1])||void 0===e?void 0:e[1],this.selection.remove(),null===(s=this.selectionChanged)||void 0===s||s.call(this),delete this.selection)}replaceSelection(){var t,e;const s=this.selection;return s&&(this[i]=null===(t=s.ends[i])||void 0===t?void 0:t[i],this[1]=null===(e=s.ends[1])||void 0===e?void 0:e[1],delete this.selection),s}depth(){let t=this.parent,e=0;for(;t;)e+=t instanceof Z?1:0,t=t.parent;return e}isTooDeep(t){if(void 0!==this.options.maxDepth)return this.depth()+(t||0)>this.options.maxDepth}}const tt=t=>class extends t{scrollHoriz(){const t=this.root.jQ[0].getBoundingClientRect();let e=0;if(this.cursor.selection){const s=this.cursor.selection.jQ[0].getBoundingClientRect(),r=s.left-(t.left+20),n=s.right-(t.right-20);if(this.cursor.selection.ends[i]===this.cursor[1])if(r<0)e=r;else{if(!(n>0))return;e=s.left-n<t.left+20?r:n}else if(n>0)e=n;else{if(!(r<0))return;e=s.right-r>t.right-20?n:r}}else{if(!this.cursor.jQ.length)return;const s=this.cursor.jQ[0].getBoundingClientRect().left;if(s>t.right-20)e=s-(t.right-20);else{if(!(s<t.left+20))return;e=s-(t.left+20)}}this.root.jQ.stop().animate({scrollLeft:`+=${e}`},100)}},et=t=>class extends t{exportLatex(){return this.root.latex().replace(/(\\[a-z]+) (?![a-z])/gi,"$1")}writeLatex(t){var e;const s=this.notify("edit").cursor;return null===(e=s.parent)||void 0===e||e.writeLatex(s,t),this}renderLatexMath(t){const e=G.skip(T.eof).or(T.all.result(!1)).parse(t);if(this.root.eachChild("postOrder","dispose"),delete this.root.ends[i],delete this.root.ends[1],e&&e.prepareInsertionAt(this.cursor)){e.children().adopt(this.root);const t=e.join("html");this.root.jQ.html(t),this.root.jQize(this.root.jQ.children()),this.root.finalizeInsert(this.cursor.options)}else this.root.jQ.empty();delete this.cursor.selection,this.cursor.insAtRightEnd(this.root)}renderLatexText(t){this.root.jQ.children().slice(1).remove(),this.root.eachChild("postOrder","dispose"),delete this.root.ends[i],delete this.root.ends[1],delete this.cursor.selection,this.cursor.show().insAtRightEnd(this.root);const e=T.string("$").then(G).skip(T.string("$").or(T.eof)).map((t=>{const e=new J(this.cursor);e.createBlocks();const s=e.ends[i];return t.children().adopt(s),e})),s=T.string("\\$").result("$").or(T.regex(/^[^$]/)).map(R),r=e.or(s).many().skip(T.eof).or(T.all.result(!1)).parse(t);if(r){for(const t of r)t.adopt(this.root,this.root.ends[1]);this.root.jQize().appendTo(this.root.jQ),this.root.finalizeInsert(this.cursor.options)}}},st=i=>class extends i{delegateMouseEvents(){const e=this.root.jQ;this.container.on("mousedown.mathquill",(i=>{var n,o;const l=t(i.target).closest(".mq-root-block"),a=q.byId[parseInt(null!==(n=(null==l?void 0:l.attr(s))||(null==e?void 0:e.attr(s)))&&void 0!==n?n:"0")];if(!a.controller)throw"controller undefined... what?";const h=a.controller,c=h.cursor,d=c.blink,u=h.textareaSpan,p=h.textarea;if(i.preventDefault(),c.options.ignoreNextMousedown(i))return;c.options.ignoreNextMousedown=()=>!1,c.endSelection();const f=t(i.target.ownerDocument);let m;const v=e=>m=t(e.target),g=t=>{var e;c.anticursor||c.startSelection(),h.seek(m,null!==(e=t.pageX)&&void 0!==e?e:0).cursor.select(),m=void 0},b=()=>{c.blink=d,c.selection||(h.editable?c.show():null==u||u.detach()),l.off("mousemove",v),f.off("mousemove",g).off("mouseup",b)};h.blurred&&(h.editable||l.prepend(u),null==p||p.focus()),c.blink=r,h.seek(t(i.target),null!==(o=i.pageX)&&void 0!==o?o:0).cursor.startSelection(),l.mousemove(v),f.mousemove(g).mouseup(b)}))}seek(t,i){var r,n;const o=this.notify("select").cursor;let a=0;if(t&&(a=parseInt(null!==(r=t.attr(s)||t.attr(e))&&void 0!==r?r:"0"),!a)){const i=t.parent();a=parseInt(null!==(n=i.attr(s)||i.attr(e))&&void 0!==n?n:"0")}const h=a?q.byId[a]:this.root;return l("nodeId is the id of some Node that exists",!!h),o.clearSelection().show(),h.seek(i,o),this.scrollHoriz(),this}},it=t=>class extends t{exportText(){return this.root.foldChildren("",((t,e)=>t+e.text()))}},rt=e=>class extends e{createTextarea(){this.textareaSpan=t('<span class="mq-textarea"></span>');const e=this.options.substituteTextarea();if(!e.nodeType)throw"substituteTextarea() must return a DOM element, got "+e.toString();this.textarea=t(e).appendTo(this.textareaSpan),this.cursor.selectionChanged=()=>this.selectionChanged()}selectionChanged(){this.textareaSelectionTimeout||(this.textareaSelectionTimeout=setTimeout((()=>this.setTextareaSelection())))}setTextareaSelection(){var t;delete this.textareaSelectionTimeout;let e="";this.cursor.selection&&(e=this.cursor.selection.join("latex"),this.options.statelessClipboard&&(e=`$${e}$`)),null===(t=this.selectFn)||void 0===t||t.call(this,e)}staticMathTextareaEvents(){var e;this.container.prepend(t('<span class="mq-selectable">').text(`$${this.exportLatex()}$`)),this.blurred=!0;const s=()=>{var t;null===(t=this.textareaSpan)||void 0===t||t.detach(),this.blurred=!0};null===(e=this.textarea)||void 0===e||e.on("cut paste",!1).on("copy",(()=>this.setTextareaSelection())).focus((()=>this.blurred=!1)).blur((()=>{this.cursor.selection&&this.cursor.selection.clear(),setTimeout(s)})),this.selectFn=t=>{var e,s;null===(e=this.textarea)||void 0===e||e.val(t),t&&(null===(s=this.textarea)||void 0===s||s.select())}}editablesTextareaEvents(){const t=this.options.substituteKeyboardEvents(this.textarea,this);this.selectFn=e=>t.select(e),this.container.prepend(this.textareaSpan),this.focusBlurEvents()}unbindEditablesEvents(){var t,e;this.selectFn=t=>{var e,s;null===(e=this.textarea)||void 0===e||e.val(t),t&&(null===(s=this.textarea)||void 0===s||s.select())},null===(t=this.textareaSpan)||void 0===t||t.remove(),this.unbindFocusBlurEvents(),this.blurred=!0,null===(e=this.textarea)||void 0===e||e.on("cut paste",!1)}typedText(t){var e;if("\n"===t)return this.handle("enter");const s=this.notify().cursor;null===(e=s.parent)||void 0===e||e.write(s,t),this.scrollHoriz()}cut(){this.cursor.selection&&setTimeout((()=>{var t;this.notify("edit"),null===(t=this.cursor.parent)||void 0===t||t.bubble("reflow")}))}copy(){this.setTextareaSelection()}paste(t){this.options.statelessClipboard&&(t="$"===t.slice(0,1)&&"$"===t.slice(-1)?t.slice(1,-1):`\\text{${t}}`),this.writeLatex(t).cursor.show()}keystroke(t,e){}};class nt{constructor(t,e,s){this.KIND_OF_MQ="",this.editable=!1,this.id=t.id,this.root=t,this.container=e,this.options=s,this.cursor=new Y(t,s)}handle(t,e){var s,r;const n=this.options.handlers;n&&n[t]&&(e===i||1===e?null===(s=n[t])||void 0===s||s(e,this.apiClass):null===(r=n[t])||void 0===r||r(this.apiClass))}notify(t){return"move"!==t&&"upDown"!==t||this.cursor.show().clearSelection(),"upDown"!==t&&(this.cursor.upDownCache={}),"edit"===t&&this.cursor.show().deleteSelection(),"select"!==t&&this.cursor.endSelection(),this}selectionChanged(){}}class ot extends(it(rt(et(D(st(tt(nt))))))){constructor(t,e,s){super(t,e,s),t.controller=this}keystroke(t,e){var s;null===(s=this.cursor.parent)||void 0===s||s.keystroke(t,e,this)}escapeDir(t,e,s){var i;a(t);const r=this.cursor;if(r.parent!==this.root&&s.preventDefault(),r.parent!==this.root)return null===(i=r.parent)||void 0===i||i.moveOutOf(t,r),this.notify("move")}moveDir(t){var e,s;a(t);const i=this.cursor,r=i.options.leftRightIntoCmdGoes;return i.selection?i.insDirOf(t,i.selection.ends[t]):i[t]?null===(e=i[t])||void 0===e||e.moveTowards(t,i,r):null===(s=i.parent)||void 0===s||s.moveOutOf(t,i,r),this.notify("move")}moveLeft(){return this.moveDir(i)}moveRight(){return this.moveDir(1)}moveUpDown(t){var e,s,r,n,o;const l=this.notify("upDown").cursor,a=`${t}Into`,h=`${t}OutOf`;return(null===(e=l[1])||void 0===e?void 0:e[a])?l.insAtLeftEnd(null===(s=l[1])||void 0===s?void 0:s[a]):(null===(r=l[i])||void 0===r?void 0:r[a])?l.insAtRightEnd(null===(n=l[i])||void 0===n?void 0:n[a]):null===(o=l.parent)||void 0===o||o.bubble((t=>{if(t[h]&&("function"==typeof t[h]&&t[h](l),t[h]instanceof q&&l.jumpUpDown(t,t[h]),!0!==t[h]))return!1})),this}moveUp(){return this.moveUpDown("up")}moveDown(){return this.moveUpDown("down")}deleteDir(t){var e,s,r,n,o,l,h,c;a(t);const d=this.cursor,u=d.selection;return this.notify("edit"),u||(d[t]?null===(e=d[t])||void 0===e||e.deleteTowards(t,d):null===(s=d.parent)||void 0===s||s.deleteOutOf(t,d)),null===(r=d[1])||void 0===r||r.postOrder("contactWeld",d),null===(o=null===(n=d[i])||void 0===n?void 0:n.siblingDeleted)||void 0===o||o.call(n,d.options,1),null===(h=null===(l=d[1])||void 0===l?void 0:l.siblingDeleted)||void 0===h||h.call(l,d.options,i),null===(c=d.parent)||void 0===c||c.bubble("reflow"),this}ctrlDeleteDir(t){var e,s,r,n,o,l,h,c;a(t);const d=this.cursor;return!d[t]||d.selection?this.deleteDir(t):(this.notify("edit"),t===i?new b(null===(e=d.parent)||void 0===e?void 0:e.ends[i],d[i]).remove():new b(d[1],null===(s=d.parent)||void 0===s?void 0:s.ends[1]).remove(),d.insAtDirEnd(t,d.parent),null===(r=d[1])||void 0===r||r.postOrder("contactWeld",d),null===(o=null===(n=d[i])||void 0===n?void 0:n.siblingDeleted)||void 0===o||o.call(n,d.options,1),null===(h=null===(l=d[1])||void 0===l?void 0:l.siblingDeleted)||void 0===h||h.call(l,d.options,i),null===(c=d.parent)||void 0===c||c.bubble("reflow"),this)}backspace(){return this.deleteDir(i)}deleteForward(){return this.deleteDir(1)}selectDir(t){var e,s;const r=this.notify("select").cursor,n=r.selection;a(t),r.anticursor||r.startSelection();const o=r[t];o?n&&(null==n?void 0:n.ends[t])===o&&(null===(e=r.anticursor)||void 0===e?void 0:e[t===i?1:i])!==o?o.unselectInto(t,r):o.selectTowards(t,r):null===(s=r.parent)||void 0===s||s.selectOutOf(t,r),r.clearSelection(),r.select()||r.show()}selectLeft(){return this.selectDir(i)}selectRight(){return this.selectDir(1)}}class lt{constructor(t){this.__controller=t,this.__controller.apiClass=this,this.__options=t.options,this.id=t.id}__mathquillify(e){const i=this.__controller.root,r=this.__controller.container;this.__controller.createTextarea();const n=r.addClass(null!=e?e:"").contents().detach();i.jQ=t('<span class="mq-root-block"/>').attr(s,i.id).appendTo(r),this.latex(n.text()),this.revert=()=>r.empty().off().removeClass("mq-editable-field mq-math-mode mq-text-mode").append(n)}config(t){return g.config(this.__options,t),this}el(){return this.__controller.container[0]}text(){return this.__controller.exportText()}latex(t){var e;return void 0!==t?(this.__controller.renderLatexMath(t),this.__controller.blurred&&(null===(e=this.__controller.cursor.hide().parent)||void 0===e||e.blur()),this):this.__controller.exportLatex()}html(){return this.__controller.root.jQ.html().replace(/ mathquill-(?:command|block)-id="?\d+"?/g,"").replace(/<span class="?mq-cursor( mq-blink)?"?>.?<\/span>/i,"").replace(/ mq-hasCursor|mq-hasCursor ?/,"").replace(/ class=(""|(?= |>))/g,"")}reflow(){return this.__controller.root.postOrder("reflow"),this}}class at extends lt{__mathquillify(t){return super.__mathquillify(t),this.__controller.editable=!0,this.__controller.delegateMouseEvents(),this.__controller.editablesTextareaEvents(),this}focus(){var t;return null===(t=this.__controller.textarea)||void 0===t||t.focus(),this}blur(){var t;return null===(t=this.__controller.textarea)||void 0===t||t.blur(),this}write(t){var e;return this.__controller.writeLatex(t),this.__controller.scrollHoriz(),this.__controller.blurred&&(null===(e=this.__controller.cursor.hide().parent)||void 0===e||e.blur()),this}empty(){const t=this.__controller.root,e=this.__controller.cursor;return t.eachChild("postOrder","dispose"),delete t.ends[i],delete t.ends[1],t.jQ.empty(),delete e.selection,e.insAtRightEnd(t),this}cmd(t){var e,s;const i=this.__controller.notify(),r=i.cursor;if(/^\\[a-z]+$/i.test(t)&&!r.isTooDeep()){t=t.slice(1);const e=c[t];if(e){const s=new e(t);r.selection&&s.replaces(r.replaceSelection()),s.createLeftOf(r.show()),this.__controller.scrollHoriz()}}else null===(e=r.parent)||void 0===e||e.write(r,t);return i.blurred&&(null===(s=r.hide().parent)||void 0===s||s.blur()),this}select(){const t=this.__controller;for(t.notify("move").cursor.insAtRightEnd(t.root);t.cursor[i];)t.selectLeft();return this}clearSelection(){return this.__controller.cursor.clearSelection(),this}moveToDirEnd(t){return this.__controller.notify("move").cursor.insAtDirEnd(t,this.__controller.root),this}moveToLeftEnd(){return this.moveToDirEnd(i)}moveToRightEnd(){return this.moveToDirEnd(1)}keystroke(t){const e=t.replace(/^\s+|\s+$/g,"").split(/\s+/);for(const t of e){const e=new Event("noop");e.preventDefault=r,this.__controller.keystroke(t,e)}return this}typedText(t){for(const e of t)this.__controller.typedText(e);return this}dropEmbedded(e,s,i){var r,n;const o=document.elementFromPoint(e-(null!==(r=t(window).scrollLeft())&&void 0!==r?r:0),s-(null!==(n=t(window).scrollTop())&&void 0!==n?n:0));this.__controller.seek(t(o),e);(new c.embed).setOptions(i).createLeftOf(this.__controller.cursor)}clickAt(e,s,i){i=i||document.elementFromPoint(e,s);const r=this.__controller,n=r.root;return t.contains(n.jQ[0],i)||(i=n.jQ[0]),r.seek(t(i),e+window.pageXOffset),r.blurred&&this.focus(),this}ignoreNextMousedown(t){return this.__controller.cursor.options.ignoreNextMousedown=t,this}}class ht{push(t){this[Object.keys(this).length]=t}get length(){return Object.keys(this).length}get(t){for(const e of Object.keys(this)){const s=parseInt(e);if(this[s].name===t)return this[s]}}}class ct extends lt{constructor(t){super(t),this.__controller.root.postOrder("registerInnerField",this.innerFields=new ht,ut)}__mathquillify(){return super.__mathquillify("mq-math-mode"),this.__options.mouseEvents&&(this.__controller.delegateMouseEvents(),this.__controller.staticMathTextareaEvents()),this}latex(t){const e=super.latex(t);return void 0!==t&&this.__controller.root.postOrder("registerInnerField",this.innerFields=new ht,ut),e}}ct.RootBlock=Z;class dt extends at{__mathquillify(){const t=this.__controller.root.reflow;return this.__controller.root.reflow=r,super.__mathquillify("mq-editable-field mq-math-mode"),t?this.__controller.root.reflow=t:delete this.__controller.root.reflow,this}}dt.RootBlock=X;class ut extends dt{constructor(){super(...arguments),this.name=""}makeStatic(){this.__controller.editable=!1,this.__controller.root.blur(),this.__controller.unbindEditablesEvents(),this.__controller.container.removeClass("mq-editable-field")}makeEditable(){this.__controller.editable=!0,this.__controller.editablesTextareaEvents(),this.__controller.cursor.insAtRightEnd(this.__controller.root),this.__controller.container.addClass("mq-editable-field")}}class pt extends at{__mathquillify(){return super.__mathquillify("mq-editable-field mq-text-mode")}latex(t){var e;return void 0!==t?(this.__controller.renderLatexText(t),this.__controller.blurred&&(null===(e=this.__controller.cursor.hide().parent)||void 0===e||e.blur()),this):this.__controller.exportLatex()}}pt.RootBlock=class extends X{keystroke(t,e,s){if("Spacebar"!==t&&"Shift-Spacebar"!==t)return super.keystroke(t,e,s)}write(t,e){t.show().deleteSelection(),"$"===e?new J(t).createLeftOf(t):new R(e,"<"===e?"&lt;":">"===e?"&gt;":void 0).createLeftOf(t)}};class ft extends L{constructor(t,e,s){super(t,`<${e} ${s}>&0</${e}>`)}}c.mathrm=o(ft,"\\mathrm","span",'class="mq-roman mq-font"'),c.mathit=o(ft,"\\mathit","i",'class="mq-font"'),c.mathbf=o(ft,"\\mathbf","b",'class="mq-font"'),c.mathsf=o(ft,"\\mathsf","span",'class="mq-sans-serif mq-font"'),c.mathtt=o(ft,"\\mathtt","span",'class="mq-monospace mq-font"'),c.underline=o(ft,"\\underline","span",'class="mq-non-leaf mq-underline"'),c.overline=c.bar=o(ft,"\\overline","span",'class="mq-non-leaf mq-overline"'),c.overrightarrow=o(ft,"\\overrightarrow","span",'class="mq-non-leaf mq-overarrow mq-arrow-right"'),c.overleftarrow=o(ft,"\\overleftarrow","span",'class="mq-non-leaf mq-overarrow mq-arrow-left"'),c.overleftrightarrow=o(ft,"\\overleftrightarrow","span",'class="mq-non-leaf mq-overarrow mq-arrow-both"'),c.overarc=o(ft,"\\overarc","span",'class="mq-non-leaf mq-overarc"'),c.dot=class extends L{constructor(){super("\\dot",'<span class="mq-non-leaf"><span class="mq-dot-recurring-inner"><span class="mq-dot-recurring">&#x2d9;</span><span class="mq-empty-box">&0</span></span></span>')}},c.textcolor=class extends L{setColor(t){this.color=t,this.htmlTemplate=`<span class="mq-textcolor" style="color:${t}">&0</span>`}latex(){var t;return`\\textcolor{${null!==(t=this.color)&&void 0!==t?t:""}}{${this.blocks[0].latex()}}`}parser(){return T.optWhitespace.then(T.string("{")).then(T.regex(/^[#\w\s.,()%-]*/)).skip(T.string("}")).then((t=>(this.setColor(t),super.parser())))}isStyleBlock(){return!0}},c.class=class extends L{parser(){return T.optWhitespace.then(T.string("{")).then(T.regex(/^[-\w\s\\\xA0-\xFF]*/)).skip(T.string("}")).then((t=>(this.cls=t||"",this.htmlTemplate=`<span class="mq-class ${t}">&0</span>`,super.parser())))}latex(){var t;return`\\class{${null!==(t=this.cls)&&void 0!==t?t:""}}{${this.blocks[0].latex()}}`}isStyleBlock(){return!0}},c.subscript=c._=class extends U{constructor(){super(),this.supsub="sub",this.htmlTemplate='<span class="mq-supsub mq-non-leaf"><span class="mq-sub">&0</span><span style="display:inline-block;width:0">&#8203;</span></span>',this.textTemplate=["_"]}finalizeTree(){this.downInto=this.sub=this.ends[i],this.sub.upOutOf=W,super.finalizeTree()}},c.superscript=c.supscript=c["^"]=class extends U{constructor(){super(),this.supsub="sup",this.htmlTemplate='<span class="mq-supsub mq-non-leaf mq-sup-only"><span class="mq-sup">&0</span></span>',this.textTemplate=["^(",")"]}finalizeTree(){this.upInto=this.sup=this.ends[1],this.sup.downOutOf=W,super.finalizeTree()}};class mt extends H{constructor(t,e){super(t,`<span class="mq-large-operator mq-non-leaf"><span class="mq-to"><span>&1</span></span><big>${e}</big><span class="mq-from"><span>&0</span></span></span>`,[t.length>1?t.slice(1):t])}createLeftOf(t){super.createLeftOf(t),t.options.sumStartsWithNEquals&&!this.replacedFragment&&(new N("n").createLeftOf(t),(new z).createLeftOf(t))}}c["∑"]=c.sum=c.summation=o(mt,"\\sum ","&sum;"),c["∏"]=c.prod=c.product=o(mt,"\\prod ","&prod;"),c.coprod=c.coproduct=o(mt,"\\coprod ","&#8720;"),c["∫"]=c.int=c.integral=class extends H{constructor(){super("\\int ",'<span class="mq-int mq-non-leaf"><big>&int;</big><span class="mq-supsub mq-non-leaf"><span class="mq-sup"><span class="mq-sup-inner">&1</span></span><span class="mq-sub">&0</span><span style="display:inline-block;width:0">&#8203</span></span></span>')}},c.frac=c.dfrac=c.cfrac=c.fraction=P;const vt=t=>class extends t{createLeftOf(t){var e,s,r;if(!this.replacedFragment){let n=t[i];for(;n&&!(n instanceof I||"text"in c&&n instanceof c.text||n instanceof H||"\\ "===n.ctrlSeq||/^[,;:]$/.test(n.ctrlSeq));)n=n[i];n instanceof H&&n[1]instanceof U&&(n=n[1],n&&n[1]instanceof U&&(null===(e=n[1])||void 0===e?void 0:e.ctrlSeq)!=n.ctrlSeq&&(n=n[1])),n===t[i]||t.isTooDeep(1)||(null===(s=t[i])||void 0===s?void 0:s.jQ.hasClass("mq-operator-name"))||(this.replaces(new b((null==n?void 0:n[1])||(null===(r=t.parent)||void 0===r?void 0:r.ends[i]),t[i])),t[i]=n)}super.createLeftOf(t)}};c.over=d["/"]=class extends(vt(P)){};class gt extends L{constructor(){super(),this.ctrlSeq="\\sqrt",this.htmlTemplate='<span class="mq-non-leaf"><span class="mq-scaled mq-sqrt-prefix">&radic;</span><span class="mq-non-leaf mq-sqrt-stem">&0</span></span>',this.textTemplate=["sqrt(",")"],this.reflow=()=>{var t,e;const s=null===(t=this.ends[1])||void 0===t?void 0:t.jQ;s&&C(s.prev(),1,(null!==(e=s.innerHeight())&&void 0!==e?e:0)/+s.css("fontSize").slice(0,-2)-.1)}}parser(){return G.optBlock.then((t=>G.block.map((e=>{const s=new bt;return s.blocks=[t,e],t.adopt(s),e.adopt(s,t),s})))).or(super.parser())}}c.sqrt=c["√"]=gt,c.hat=class extends L{constructor(){super("\\hat",'<span class="mq-non-leaf"><span class="mq-hat-prefix">^</span><span class="mq-hat-stem">&0</span></span>',["hat(",")"])}};class bt extends gt{constructor(){super(),this.htmlTemplate='<span class="mq-nthroot mq-non-leaf">&0</span><span class="mq-scaled"><span class="mq-sqrt-prefix mq-scaled">&radic;</span><span class="mq-sqrt-stem mq-non-leaf">&1</span></span>',this.textTemplate=["root(",",",")"]}latex(){var t,e,s,r;return`\\sqrt[${null!==(e=null===(t=this.ends[i])||void 0===t?void 0:t.latex())&&void 0!==e?e:""}]{${null!==(r=null===(s=this.ends[1])||void 0===s?void 0:s.latex())&&void 0!==r?r:""}}`}text(){var t,e,s,r,n,o,l,a;const h=null!==(e=null===(t=this.ends[i])||void 0===t?void 0:t.text())&&void 0!==e?e:"";if(""===h||"2"===h)return`sqrt(${null!==(r=null===(s=this.ends[1])||void 0===s?void 0:s.text())&&void 0!==r?r:""})`;if(function t(e){return e.controller?e.controller:t(e.parent)}(this).options.rootsAreExponents){const t=this[1]instanceof U&&"sup"===this[1].supsub;return`${t?"(":""}(${null!==(o=null===(n=this.ends[1])||void 0===n?void 0:n.text())&&void 0!==o?o:""})^(1/${h})${t?")":""}`}return`root(${h},${null!==(a=null===(l=this.ends[1])||void 0===l?void 0:l.text())&&void 0!==a?a:""})`}}c.root=c.nthroot=bt;class xt extends L{constructor(t,e,s){super(t,`<span class="mq-non-leaf"><span class="mq-diacritic-above">${e}</span><span class="mq-diacritic-stem">&0</span></span>`,s)}}c.vec=o(xt,"\\vec","&rarr;",["vec(",")"]),c.tilde=o(xt,"\\tilde","~",["tilde(",")"]);const wt=(t,e)=>{const s=e||t,r=u[t],n=u[s];d[t]=o(V,i,t,r,s,n),d[r]=o(V,1,t,r,s,n)};wt("("),wt("["),wt("{","\\{"),c.langle=o(V,i,"&lang;","&rang;","\\langle ","\\rangle "),c.rangle=o(V,1,"&lang;","&rang;","\\langle ","\\rangle "),c.abs=d["|"]=o(V,i,"|","|","|","|"),c.lVert=o(V,i,"&#8741;","&#8741;","\\lVert ","\\rVert "),c.rVert=o(V,1,"&#8741;","&#8741;","\\lVert ","\\rVert "),c.left=class extends L{parser(){return T.optWhitespace.then(T.regex(/^(?:[([|]|\\\{|\\langle(?![a-zA-Z])|\\lVert(?![a-zA-Z]))/)).then((t=>{let e="\\"===t.charAt(0)?t.slice(1):t;return"\\langle"==t&&(e="&lang;",t+=" "),"\\lVert"==t&&(e="&#8741;",t+=" "),G.then((s=>T.string("\\right").skip(T.optWhitespace).then(T.regex(/^(?:[\])|]|\\\}|\\rangle(?![a-zA-Z])|\\rVert(?![a-zA-Z]))/)).map((i=>{let r="\\"===i.charAt(0)?i.slice(1):i;"\\rangle"==i&&(r="&rang;",i=`${i} `),"\\rVert"==i&&(r="&#8741;",i=`${i} `);const n=new V(0,e,r,t,i);return n.blocks=[s],s.adopt(n),n}))))}))}},c.right=class extends L{parser(){return T.fail("unmatched \\right")}};class qt extends(Q(L)){constructor(){super("\\binom",'<span class="mq-non-leaf"><span class="mq-paren mq-scaled">(</span><span class="mq-non-leaf"><span class="mq-array mq-non-leaf"><span>&0</span><span>&1</span></span></span><span class="mq-paren mq-scaled">)</span></span>',["choose(",",",")"])}}c.binom=c.binomial=qt,c.choose=class extends(vt(qt)){},c.editable=c.MathQuillMathField=class extends L{constructor(){super("\\MathQuillMathField",'<span class="mq-editable-field"><span class="mq-root-block">&0</span></span>'),this.name=""}parser(){return T.string("[").then(T.regex(/^[a-z][a-z0-9]*/i)).skip(T.string("]")).map((t=>this.name=t)).or(T.succeed()).then(super.parser())}finalizeTree(t){const e=new ot(this.ends[i],this.jQ,t);e.KIND_OF_MQ="MathField",this.field=new ut(e),this.field.name=this.name,e.editable=!0,e.createTextarea(),e.editablesTextareaEvents(),e.cursor.insAtRightEnd(e.root),y(e.root),this.field.blur()}registerInnerField(t){t.push(this.field)}latex(){var t,e;return null!==(e=null===(t=this.ends[i])||void 0===t?void 0:t.latex())&&void 0!==e?e:""}text(){var t,e;return null!==(e=null===(t=this.ends[i])||void 0===t?void 0:t.text())&&void 0!==e?e:""}},c.embed=class extends A{setOptions(t){const e=()=>"";return this.text=t.text||e,this.htmlTemplate=t.htmlString||"",this.latex=t.latex||e,this}parser(){return T.string("{").then(T.regex(/^[a-z][a-z0-9]*/i)).skip(T.string("}")).then((t=>T.string("[").then(T.regex(/^[-\w\s]*/)).skip(T.string("]")).or(T.succeed()).map((e=>this.setOptions(p[t](e))))))}};class Ot extends(E(S(q))){constructor(){super(),this.anticursorPosition=0,this.ctrlSeq="\\text"}replaces(t){t instanceof b?this.replacedText=t.remove().jQ.text():"string"==typeof t&&(this.replacedText=t)}jQadd(t){var e;super.jQadd(t),null===(e=this.ends[i])||void 0===e||e.jQadd(this.jQ[0].firstChild)}createLeftOf(t){var e,s,r,n;if(super.createLeftOf(t),t.insAtRightEnd(this),this.replacedText)for(const e of this.replacedText)this.write(t,e);null===(s=null===(e=this[1])||void 0===e?void 0:e.siblingCreated)||void 0===s||s.call(e,t.options,i),null===(n=null===(r=this[i])||void 0===r?void 0:r.siblingCreated)||void 0===n||n.call(r,t.options,1),this.bubble("reflow")}parser(){return T.optWhitespace.then(T.string("{")).then(T.regex(/^(\\}|[^}])*/)).skip(T.string("}")).map((t=>0===t.length?new b:(new yt(t.replace(/\\{/g,"{").replace(/\\}/g,"}")).adopt(this),this)))}textContents(){return this.foldChildren("",((t,e)=>t+e.text()))}text(){return this.textContents()}latex(){const t=this.textContents();return 0===t.length?"":"\\text{"+t.replace(/[{}]/g,"\\$&")+"}"}html(){return`<span class="mq-text-mode" ${e}=${this.id}>${this.textContents()}</span>`}moveTowards(t,e){e.insAtDirEnd(t===i?1:i,this)}moveOutOf(t,e){e.insDirOf(t,this)}unselectInto(t,e){e.insAtDirEnd(t===i?1:i,this);const s=e[t].splitRight(this.anticursorPosition);t===i&&(e[i]=s),e.anticursor=new O(this,s[i],s),e.anticursor.ancestors={};for(let t=e.anticursor;t.parent;t=t.parent)e.anticursor.ancestors[t.parent.id]=t}selectOutOf(t,e){var s,r,n,o,l,a;this.anticursorPosition=t===i?(null!==(n=null===(r=null===(s=e.selection)||void 0===s?void 0:s.jQ[0].textContent)||void 0===r?void 0:r.length)&&void 0!==n?n:1)-1:this.textContents().length-(null!==(a=null===(l=null===(o=e.selection)||void 0===o?void 0:o.jQ[0].textContent)||void 0===l?void 0:l.length)&&void 0!==a?a:1)+1,e.insDirOf(t,this)}deleteOutOf(t,e){this.isEmpty()&&e.insRightOf(this)}write(t,e){if(t.show().deleteSelection(),"$"!==e)this.postOrder("reflow"),t[i]?t[i].appendText(e):new yt(e).createLeftOf(t),this.bubble("reflow");else if(this.isEmpty())t.insRightOf(this),new R("\\$","$").createLeftOf(t);else if(t[1])if(t[i]){const e=new Ot,s=this.ends[i];s.disown().jQ.detach(),s.adopt(e),t.insLeftOf(this),super.createLeftOf.call(e,t)}else t.insLeftOf(this);else t.insRightOf(this);this.bubble("reflow")}writeLatex(t,e){t[i]?t[i].appendText(e):new yt(e).createLeftOf(t),this.bubble("reflow")}seek(t,e){var s,r,n,o,l,a,h,c,d,u,p,f,m;e.hide();const v=this.fuseChildren(),g=(null!==(s=this.jQ.width())&&void 0!==s?s:0)/this.text().length,b=Math.round((t-(null!==(n=null===(r=this.jQ.offset())||void 0===r?void 0:r.left)&&void 0!==n?n:0))/g);b<=0?e.insAtLeftEnd(this):b>=v.text().length?e.insAtRightEnd(this):e.insLeftOf(v.splitRight(b));let x=t-(null!==(l=null===(o=e.show().offset())||void 0===o?void 0:o.left)&&void 0!==l?l:0);const w=x&&x<0?i:1;let q=w;for(;e[w]&&x*q>0;)null===(a=e[w])||void 0===a||a.moveTowards(w,e),q=x,x=t-(null!==(c=null===(h=e.offset())||void 0===h?void 0:h.left)&&void 0!==c?c:0);if(w*x<-w*q&&(null===(d=e[w===i?1:i])||void 0===d||d.moveTowards(w===i?1:i,e)),e.anticursor){if(e.anticursor.parent===this){const t=null!==(m=e[i]&&(null===(f=e[i])||void 0===f?void 0:f.text().length))&&void 0!==m?m:0;if(this.anticursorPosition===t)e.startSelection();else{let s;this.anticursorPosition<t?(s=e[i].splitRight(this.anticursorPosition),e[i]=s):s=e[1].splitRight(this.anticursorPosition-t),e.anticursor=new O(this,s[i],s),e.anticursor.ancestors={};for(let t=e.anticursor;t.parent;t=t.parent)e.anticursor.ancestors[t.parent.id]=t}}}else this.anticursorPosition=null!==(p=e[i]&&(null===(u=e[i])||void 0===u?void 0:u.text().length))&&void 0!==p?p:0}blur(t){super.blur(),t&&(""===this.textContents()?(this.remove(),t[i]===this?t[i]=this[i]:t[1]===this&&(t[1]=this[1])):(this.jQ.find(".mq-selection").length&&t.clearSelection(),this.fuseChildren()),function t(e){return(null==e?void 0:e.controller)?null==e?void 0:e.controller:t(null==e?void 0:e.parent)}(t.parent).handle("textBlockExit"))}fuseChildren(){this.jQ[0].normalize();const t=this.jQ[0].firstChild;if(!t)return;l("only node in TextBlock span is Text node",3===t.nodeType);const e=new yt(t.data);return e.jQadd(t),this.children().disown(),e.adopt(this)}focus(){super.focus(),function t(e){return(null==e?void 0:e.controller)?null==e?void 0:e.controller:t(null==e?void 0:e.parent)}(this).handle("textBlockEnter")}}class yt extends q{constructor(t){super(),this.textStr=t}text(){return this.textStr}jQadd(e){this.dom=e,this.jQ=t(e)}jQize(){return this.jQadd(document.createTextNode(this.textStr)),this.jQ}appendText(t){var e;this.textStr+=t,null===(e=this.dom)||void 0===e||e.appendData(t)}prependText(t){var e;this.textStr=t+this.textStr,null===(e=this.dom)||void 0===e||e.insertData(0,t)}insTextAtDirEnd(t,e){a(e),1===e?this.appendText(t):this.prependText(t)}splitRight(t){var e;const s=new yt(this.textStr.slice(t)).adopt(this.parent,this,this[1]);return s.jQadd(null===(e=this.dom)||void 0===e?void 0:e.splitText(t)),this.textStr=this.textStr.slice(0,t),s}endChar(t,e){return e.charAt(t===i?0:-1+e.length)}moveTowards(t,e){a(t);const s=this.endChar(t===i?1:i,this.textStr),r=this[t===i?1:i];return r?r.insTextAtDirEnd(s,t):new yt(s).createDir(t===i?1:i,e),this.deleteTowards(t,e)}latex(){return this.textStr}deleteTowards(t,e){var s,i;this.textStr.length>1?1===t?(null===(s=this.dom)||void 0===s||s.deleteData(0,1),this.textStr=this.textStr.slice(1)):(null===(i=this.dom)||void 0===i||i.deleteData(-1+this.textStr.length,1),this.textStr=this.textStr.slice(0,-1)):(this.remove(),this.jQ.remove(),e[t]=this[t])}selectTowards(t,e){var s;a(t);const r=e.anticursor,n=this.endChar(t===i?1:i,this.textStr);if((null==r?void 0:r[t])===this){const s=new yt(n).createDir(t,e);r[t]=s,e.insDirOf(t,s)}else{const o=this[t===i?1:i];if(o)o.insTextAtDirEnd(n,t);else{new yt(n).createDir(t===i?1:i,e).jQ.insDirOf(t===i?1:i,null===(s=e.selection)||void 0===s?void 0:s.jQ)}1===this.textStr.length&&(null==r?void 0:r[t===i?1:i])===this&&(r[t===i?1:i]=this[t===i?1:i])}return this.deleteTowards(t,e)}}c.text=c.textnormal=c.textrm=c.textup=d['"']=c.textmd=Ot;const St=(t,e,s)=>class extends Ot{constructor(){super(),this.ctrlSeq=t,this.htmlTemplate=`<${e} ${s}>&0</${e}>`}};c.em=c.italic=c.italics=c.emph=c.textit=c.textsl=St("\\textit","i",'class="mq-text-mode"'),c.strong=c.bold=c.textbf=St("\\textbf","b",'class="mq-text-mode"'),c.sf=c.textsf=St("\\textsf","span",'class="mq-sans-serif mq-text-mode"'),c.tt=c.texttt=St("\\texttt","span",'class="mq-monospace mq-text-mode"'),c.textsc=St("\\textsc","span",'style="font-variant:small-caps" class="mq-text-mode"'),c.uppercase=St("\\uppercase","span",'style="text-transform:uppercase" class="mq-text-mode"'),c.lowercase=St("\\lowercase","span",'style="text-transform:lowercase" class="mq-text-mode"'),d["\\"]=class extends L{constructor(){super(),this.ctrlSeq="\\",this.htmlTemplate='<span class="mq-latex-command-input mq-non-leaf">\\<span>&0</span></span>',this.textTemplate=["\\"]}replaces(t){this._replacedFragment=null==t?void 0:t.disown(),this.isEmpty=()=>!1}createBlocks(){super.createBlocks();const t=this.ends[i];t.focus=()=>{var e,s;return null===(e=t.parent)||void 0===e||e.jQ.addClass("mq-hasCursor"),t.isEmpty()&&(null===(s=t.parent)||void 0===s||s.jQ.removeClass("mq-empty")),t},t.blur=()=>{var e,s;return null===(e=t.parent)||void 0===e||e.jQ.removeClass("mq-hasCursor"),t.isEmpty()&&(null===(s=t.parent)||void 0===s||s.jQ.addClass("mq-empty")),t},t.write=(e,s)=>{var i;e.show().deleteSelection(),s.match(/[a-z]/i)?new R(s).createLeftOf(e):(t.parent.renderCommand(e),"\\"===s&&t.isEmpty()||null===(i=e.parent)||void 0===i||i.write(e,s))},t.keystroke=(e,s,i)=>"Tab"===e||"Enter"===e||"Spacebar"===e?(t.parent.renderCommand(i.cursor),void s.preventDefault()):super.keystroke(e,s,i)}createLeftOf(e){if(super.createLeftOf(e),this._replacedFragment){const e=this.jQ[0];this.jQ=this._replacedFragment.jQ.addClass("mq-blur").on("mousedown mousemove",(s=>(t(s.target=e).trigger(s),!1))).insertBefore(this.jQ).add(this.jQ)}}latex(){var t,e;return"\\"+(null!==(e=null===(t=this.ends[i])||void 0===t?void 0:t.latex())&&void 0!==e?e:"")+" "}renderCommand(t){var e;this.jQ=this.jQ.last(),this.remove(),this[1]?t.insLeftOf(this[1]):t.insAtRightEnd(this.parent);const s=(null===(e=this.ends[i])||void 0===e?void 0:e.latex())||" ";if(s in c){const e=new c[s](s);this._replacedFragment&&e.replaces(this._replacedFragment),e.createLeftOf(t)}else{const e=new Ot;e.replaces(s),e.createLeftOf(t),t.insRightOf(e),this._replacedFragment&&this._replacedFragment.remove()}}};class kt extends A{constructor(t){super(),this.ctrlSeq=t}createLeftOf(t){for(const e of this.ctrlSeq)new N(e).createLeftOf(t)}parser(){const t=new Z;for(const e of this.ctrlSeq)new N(e).adopt(t,t.ends[1]);return T.succeed(t.children())}}for(const t in g.autoOperatorNames)"_maxLength"!==t&&(c[t]=kt);c.operatorname=class extends L{constructor(t,e,s){super(t,e,s),this.createLeftOf=r}numBlocks(){return 1}parser(){return G.block.map((t=>t.children()))}},c.f=class extends N{constructor(){super("f",'<var class="mq-f">f</var>'),this.letter="f"}italicize(t){return this.jQ.html("f").toggleClass("mq-f",t),super.italicize(t)}},c[" "]=c.space=o(R,"\\ ","&nbsp;"),c["'"]=c.prime=o(R,"'","&prime;"),c.backslash=o(R,"\\backslash ","\\"),d["\\"]||(d["\\"]=c.backslash),c.$=o(R,"\\$","$");class _t extends A{constructor(t,e){super(t,`<span class="mq-nonSymbola">${e||t}</span>`)}}c["@"]=_t,c["&"]=o(_t,"\\&","&amp;"),c["%"]=o(_t,"\\%","%"),c.alpha=c.beta=c.gamma=c.delta=c.zeta=c.eta=c.theta=c.iota=c.kappa=c.mu=c.nu=c.xi=c.rho=c.sigma=c.tau=c.chi=c.psi=c.omega=class extends M{constructor(t){super(`\\${t} `,`&${t};`)}},c.phi=o(M,"\\phi ","&#981;"),c.phiv=c.varphi=o(M,"\\varphi ","&phi;"),c.epsilon=o(M,"\\epsilon ","&#1013;"),c.epsiv=c.varepsilon=o(M,"\\varepsilon ","&epsilon;"),c.piv=c.varpi=o(M,"\\varpi ","&piv;"),c.sigmaf=c.sigmav=c.varsigma=o(M,"\\varsigma ","&sigmaf;"),c.thetav=c.vartheta=c.thetasym=o(M,"\\vartheta ","&thetasym;"),c.upsilon=c.upsi=o(M,"\\upsilon ","&upsilon;"),c.gammad=c.Gammad=c.digamma=o(M,"\\digamma ","&#989;"),c.kappav=c.varkappa=o(M,"\\varkappa ","&#1008;"),c.rhov=c.varrho=o(M,"\\varrho ","&#1009;"),c.pi=c["π"]=o(_t,"\\pi ","&pi;"),c.lambda=o(_t,"\\lambda ","&lambda;"),c.Upsilon=c.Upsi=c.upsih=c.Upsih=o(A,"\\Upsilon ",'<var style="font-family: serif">&upsih;</var>'),c.Gamma=c.Delta=c.Theta=c.Lambda=c.Xi=c.Pi=c.Sigma=c.Phi=c.Psi=c.Omega=c.forall=class extends R{constructor(t){super(`\\${t} `,`&${t};`)}};class jt extends L{constructor(t){super(),this.latex=()=>t}createLeftOf(t){var e,s,r,n,o,l,a;const h=G.parse(this.latex());h.children().adopt(t.parent,t[i],t[1]),t[i]=h.ends[1],h.jQize().insertBefore(t.jQ),h.finalizeInsert(t.options,t),null===(r=null===(s=null===(e=h.ends[1])||void 0===e?void 0:e[1])||void 0===s?void 0:s.siblingCreated)||void 0===r||r.call(s,t.options,i),null===(l=null===(o=null===(n=h.ends[i])||void 0===n?void 0:n[i])||void 0===o?void 0:o.siblingCreated)||void 0===l||l.call(o,t.options,1),null===(a=t.parent)||void 0===a||a.bubble("reflow")}parser(){const t=G.parse(this.latex());return T.succeed(t.children())}}c["¹"]=o(jt,"^1"),c["²"]=o(jt,"^2"),c["³"]=o(jt,"^3"),c["¼"]=o(jt,"\\frac14"),c["½"]=o(jt,"\\frac12"),c["¾"]=o(jt,"\\frac34");class Ct extends I{constructor(t,e,s){super(t,`<span>${e||t}</span>`,s,!0),this.siblingCreated=this.siblingDeleted=(t,e)=>this.contactWeld(t,e)}contactWeld(t,e){const s=t=>t[i]?!!(t[i]instanceof I||/^[,;:([]$/.test(t[i].ctrlSeq)):!(t.parent&&t.parent.parent&&t.parent.parent.isStyleBlock())||s(t.parent.parent);if(1!==e)return this.isUnary=s(this),this.jQ[0].className=this.isUnary?"":"mq-binary-operator",this}}c["+"]=o(Ct,"+","+"),c["–"]=c["-"]=o(Ct,"-","&minus;"),c["±"]=c.pm=c.plusmn=c.plusminus=o(Ct,"\\pm ","&plusmn;"),c.mp=c.mnplus=c.minusplus=o(Ct,"\\mp ","&#8723;"),d["*"]=c.sdot=c.cdot=o(I,"\\cdot ","&middot;","*");const Qt={ctrlSeq:"\\le ",html:"&le;",text:"<=",ctrlSeqStrict:"<",htmlStrict:"&lt;",textStrict:"<"},Tt={ctrlSeq:"\\ge ",html:"&ge;",text:">=",ctrlSeqStrict:">",htmlStrict:"&gt;",textStrict:">"};c["<"]=c.lt=o(B,Qt,!0),c[">"]=c.gt=o(B,Tt,!0),c["≤"]=c.le=c.leq=o(B,Qt,!1),c["≥"]=c.ge=c.geq=o(B,Tt,!1),c["="]=z,c["×"]=c.times=o(I,"\\times ","&times;","*"),c["÷"]=c.div=c.divide=c.divides=o(I,"\\div ","&divide;","/"),d["~"]=c.sim=o(I,"\\sim ","~","~"),c.notin=c.cong=c.equiv=c.oplus=c.otimes=class extends I{constructor(t){super(`\\${t} `,`&${t};`)}},c["≠"]=c.ne=c.neq=o(I,"\\ne ","&ne;"),c["∗"]=c.ast=c.star=c.loast=c.lowast=o(I,"\\ast ","&lowast;"),c.therefor=c.therefore=o(I,"\\therefore ","&there4;"),c.cuz=c.because=o(I,"\\because ","&#8757;"),c.prop=c.propto=o(I,"\\propto ","&prop;"),c["≈"]=c.asymp=c.approx=o(I,"\\approx ","&asymp;"),c.isin=c.in=o(I,"\\in ","&isin;"),c.ni=c.contains=o(I,"\\ni ","&ni;"),c.notni=c.niton=c.notcontains=c.doesnotcontain=o(I,"\\not\\ni ","&#8716;"),c.sub=c.subset=o(I,"\\subset ","&sub;"),c.sup=c.supset=c.superset=o(I,"\\supset ","&sup;"),c.nsub=c.notsub=c.nsubset=c.notsubset=o(I,"\\not\\subset ","&#8836;"),c.nsup=c.notsup=c.nsupset=c.notsupset=c.nsuperset=c.notsuperset=o(I,"\\not\\supset ","&#8837;"),c.sube=c.subeq=c.subsete=c.subseteq=o(I,"\\subseteq ","&sube;"),c.supe=c.supeq=c.supsete=c.supseteq=c.supersete=c.superseteq=o(I,"\\supseteq ","&supe;"),c.nsube=c.nsubeq=c.notsube=c.notsubeq=c.nsubsete=c.nsubseteq=c.notsubsete=c.notsubseteq=o(I,"\\not\\subseteq ","&#8840;"),c.nsupe=c.nsupeq=c.notsupe=c.notsupeq=c.nsupsete=c.nsupseteq=c.notsupsete=c.notsupseteq=c.nsupersete=c.nsuperseteq=c.notsupersete=c.notsuperseteq=o(I,"\\not\\supseteq ","&#8841;"),c.mathbb=class extends L{constructor(t,e,s){super(t,e,s),this.createLeftOf=r}numBlocks(){return 1}parser(){return T.optWhitespace.then(T.string("{")).then(T.optWhitespace).then(T.regex(/^[NPZQRCH]/)).skip(T.optWhitespace).skip(T.string("}")).map((t=>new c[t]))}},c.N=c.naturals=c.Naturals=o(R,"\\mathbb{N}","&#8469;"),c.P=c.primes=c.Primes=c.projective=c.Projective=c.probability=c.Probability=o(R,"\\mathbb{P}","&#8473;"),c.Z=c.integers=c.Integers=o(R,"\\mathbb{Z}","&#8484;"),c.Q=c.rationals=c.Rationals=o(R,"\\mathbb{Q}","&#8474;"),c.R=c.reals=c.Reals=o(R,"\\mathbb{R}","&#8477;"),c.C=c.complex=c.Complex=c.complexes=c.Complexes=c.complexplane=c.Complexplane=c.ComplexPlane=o(R,"\\mathbb{C}","&#8450;"),c.H=c.Hamiltonian=c.quaternions=c.Quaternions=o(R,"\\mathbb{H}","&#8461;"),c.quad=c.emsp=o(R,"\\quad ","    "),c.qquad=o(R,"\\qquad ","        "),c.diamond=o(R,"\\diamond ","&#9671;"),c.bigtriangleup=o(R,"\\bigtriangleup ","&#9651;"),c.ominus=o(R,"\\ominus ","&#8854;"),c.uplus=o(R,"\\uplus ","&#8846;"),c.bigtriangledown=o(R,"\\bigtriangledown ","&#9661;"),c.sqcap=o(R,"\\sqcap ","&#8851;"),c.triangleleft=o(R,"\\triangleleft ","&#8882;"),c.sqcup=o(R,"\\sqcup ","&#8852;"),c.triangleright=o(R,"\\triangleright ","&#8883;"),c.odot=c.circledot=o(R,"\\odot ","&#8857;"),c.bigcirc=o(R,"\\bigcirc ","&#9711;"),c.dagger=o(R,"\\dagger ","&#0134;"),c.ddagger=o(R,"\\ddagger ","&#135;"),c.wr=o(R,"\\wr ","&#8768;"),c.amalg=o(R,"\\amalg ","&#8720;"),c.models=o(R,"\\models ","&#8872;"),c.prec=o(R,"\\prec ","&#8826;"),c.succ=o(R,"\\succ ","&#8827;"),c.preceq=o(R,"\\preceq ","&#8828;"),c.succeq=o(R,"\\succeq ","&#8829;"),c.simeq=o(R,"\\simeq ","&#8771;"),c.mid=o(R,"\\mid ","&#8739;"),c.ll=o(R,"\\ll ","&#8810;"),c.gg=o(R,"\\gg ","&#8811;"),c.parallel=o(R,"\\parallel ","&#8741;"),c.nparallel=o(R,"\\nparallel ","&#8742;"),c.bowtie=o(R,"\\bowtie ","&#8904;"),c.sqsubset=o(R,"\\sqsubset ","&#8847;"),c.sqsupset=o(R,"\\sqsupset ","&#8848;"),c.smile=o(R,"\\smile ","&#8995;"),c.sqsubseteq=o(R,"\\sqsubseteq ","&#8849;"),c.sqsupseteq=o(R,"\\sqsupseteq ","&#8850;"),c.doteq=o(R,"\\doteq ","&#8784;"),c.frown=o(R,"\\frown ","&#8994;"),c.vdash=o(R,"\\vdash ","&#8870;"),c.dashv=o(R,"\\dashv ","&#8867;"),c.nless=o(R,"\\nless ","&#8814;"),c.ngtr=o(R,"\\ngtr ","&#8815;"),c.longleftarrow=o(R,"\\longleftarrow ","&#8592;"),c.longrightarrow=o(R,"\\longrightarrow ","&#8594;"),c.Longleftarrow=o(R,"\\Longleftarrow ","&#8656;"),c.Longrightarrow=o(R,"\\Longrightarrow ","&#8658;"),c.longleftrightarrow=o(R,"\\longleftrightarrow ","&#8596;"),c.updownarrow=o(R,"\\updownarrow ","&#8597;"),c.Longleftrightarrow=o(R,"\\Longleftrightarrow ","&#8660;"),c.Updownarrow=o(R,"\\Updownarrow ","&#8661;"),c.mapsto=o(R,"\\mapsto ","&#8614;"),c.nearrow=o(R,"\\nearrow ","&#8599;"),c.hookleftarrow=o(R,"\\hookleftarrow ","&#8617;"),c.hookrightarrow=o(R,"\\hookrightarrow ","&#8618;"),c.searrow=o(R,"\\searrow ","&#8600;"),c.leftharpoonup=o(R,"\\leftharpoonup ","&#8636;"),c.rightharpoonup=o(R,"\\rightharpoonup ","&#8640;"),c.swarrow=o(R,"\\swarrow ","&#8601;"),c.leftharpoondown=o(R,"\\leftharpoondown ","&#8637;"),c.rightharpoondown=o(R,"\\rightharpoondown ","&#8641;"),c.nwarrow=o(R,"\\nwarrow ","&#8598;"),c.ldots=o(R,"\\ldots ","&#8230;"),c.cdots=o(R,"\\cdots ","&#8943;"),c.vdots=o(R,"\\vdots ","&#8942;"),c.ddots=o(R,"\\ddots ","&#8945;"),c.surd=o(R,"\\surd ","&#8730;"),c.triangle=o(R,"\\triangle ","&#9651;"),c.ell=o(R,"\\ell ","&#8467;"),c.top=o(R,"\\top ","&#8868;"),c.flat=o(R,"\\flat ","&#9837;"),c.natural=o(R,"\\natural ","&#9838;"),c.sharp=o(R,"\\sharp ","&#9839;"),c.wp=o(R,"\\wp ","&#8472;"),c.bot=o(R,"\\bot ","&#8869;"),c.clubsuit=o(R,"\\clubsuit ","&#9827;"),c.diamondsuit=o(R,"\\diamondsuit ","&#9826;"),c.heartsuit=o(R,"\\heartsuit ","&#9825;"),c.spadesuit=o(R,"\\spadesuit ","&#9824;"),c.parallelogram=o(R,"\\parallelogram ","&#9649;"),c.square=o(R,"\\square ","&#11036;"),c.oint=o(R,"\\oint ","&#8750;"),c.bigcap=o(R,"\\bigcap ","&#8745;"),c.bigcup=o(R,"\\bigcup ","&#8746;"),c.bigsqcup=o(R,"\\bigsqcup ","&#8852;"),c.bigvee=o(R,"\\bigvee ","&#8744;"),c.bigwedge=o(R,"\\bigwedge ","&#8743;"),c.bigodot=o(R,"\\bigodot ","&#8857;"),c.bigotimes=o(R,"\\bigotimes ","&#8855;"),c.bigoplus=o(R,"\\bigoplus ","&#8853;"),c.biguplus=o(R,"\\biguplus ","&#8846;"),c.lfloor=o(R,"\\lfloor ","&#8970;"),c.rfloor=o(R,"\\rfloor ","&#8971;"),c.lceil=o(R,"\\lceil ","&#8968;"),c.rceil=o(R,"\\rceil ","&#8969;"),c.opencurlybrace=c.lbrace=o(R,"\\lbrace ","{"),c.closecurlybrace=c.rbrace=o(R,"\\rbrace ","}"),c.lbrack=o(R,"["),c.rbrack=o(R,"]"),c.slash=o(R,"/"),c.vert=o(R,"|"),c.perp=c.perpendicular=o(R,"\\perp ","&perp;"),c.nabla=c.del=o(R,"\\nabla ","&nabla;"),c.hbar=o(R,"\\hbar ","&#8463;"),c.AA=c.Angstrom=c.angstrom=o(R,"\\text\\AA ","&#8491;"),c.ring=c.circ=c.circle=o(R,"\\circ ","&#8728;"),c.bull=c.bullet=o(R,"\\bullet ","&bull;"),c.setminus=c.smallsetminus=o(R,"\\setminus ","&#8726;"),c.not=c["¬"]=c.neg=o(R,"\\neg ","&not;"),c["…"]=c.dots=c.ellip=c.hellip=c.ellipsis=c.hellipsis=o(R,"\\dots ","&hellip;"),c.converges=c.darr=c.dnarr=c.dnarrow=c.downarrow=o(R,"\\downarrow ","&darr;"),c.dArr=c.dnArr=c.dnArrow=c.Downarrow=o(R,"\\Downarrow ","&dArr;"),c.diverges=c.uarr=c.uparrow=o(R,"\\uparrow ","&uarr;"),c.uArr=c.Uparrow=o(R,"\\Uparrow ","&uArr;"),c.to=o(I,"\\to ","&rarr;"),c.rarr=c.rightarrow=o(R,"\\rightarrow ","&rarr;"),c.implies=o(I,"\\Rightarrow ","&rArr;"),c.rArr=c.Rightarrow=o(R,"\\Rightarrow ","&rArr;"),c.gets=o(I,"\\gets ","&larr;"),c.larr=c.leftarrow=o(R,"\\leftarrow ","&larr;"),c.impliedby=o(I,"\\Leftarrow ","&lArr;"),c.lArr=c.Leftarrow=o(R,"\\Leftarrow ","&lArr;"),c.harr=c.lrarr=c.leftrightarrow=o(R,"\\leftrightarrow ","&harr;"),c.iff=o(I,"\\Leftrightarrow ","&hArr;"),c.hArr=c.lrArr=c.Leftrightarrow=o(R,"\\Leftrightarrow ","&hArr;"),c.Re=c.Real=c.real=o(R,"\\Re ","&real;"),c.Im=c.imag=c.image=c.imagin=c.imaginary=c.Imaginary=o(R,"\\Im ","&image;"),c.part=c.partial=o(R,"\\partial ","&part;"),c.inf=c.infty=c.infin=c.infinity=o(R,"\\infty ","&infin;","inf"),c.pounds=o(R,"\\pounds ","&pound;"),c.alef=c.alefsym=c.aleph=c.alephsym=o(R,"\\aleph ","&alefsym;"),c.xist=c.xists=c.exist=c.exists=o(R,"\\exists ","&exist;"),c.nexists=c.nexist=o(R,"\\nexists ","&#8708;"),c.and=c.land=c.wedge=o(I,"\\wedge ","&and;"),c.or=c.lor=c.vee=o(I,"\\vee ","&or;"),c.o=c.O=c.empty=c.emptyset=c.oslash=c.Oslash=c.nothing=c.varnothing=o(I,"\\varnothing ","&empty;"),c.U=c.cup=c.union=o(I,"\\cup ","&cup;","U"),c.cap=c.intersect=c.intersection=o(I,"\\cap ","&cap;"),c.deg=c.degree=o(R,"\\degree ","&deg;"),c.ang=c.angle=o(R,"\\angle ","&ang;"),c.measuredangle=o(R,"\\measuredangle ","&#8737;");class Dt{static getInterface(){const e={},i=e=>{if(!(e instanceof HTMLElement))return;const i=t(e).children(".mq-root-block").attr(s),r=i?q.byId[parseInt(i)].controller:void 0;return null==r?void 0:r.apiClass};i.saneKeyboardEvents=v,i.config=t=>(g.config(g.prototype,t),i),i.registerEmbed=(t,e)=>{if(!/^[a-z][a-z0-9]*$/i.test(t))throw"Embed name must start with letter and be only letters and digits";p[t]=e};for(const[s,r]of Object.entries({StaticMath:ct,MathField:dt,InnerMathField:ut,TextField:pt}))e[s]=r,(i[s]=(r,n)=>{const o=i(r);if(o instanceof e[s]||!(r instanceof HTMLElement))return o;const l=new ot(new e[s].RootBlock,t(r),new g);return l.KIND_OF_MQ=s,new e[s](l).config(n).__mathquillify()}).prototype=e[s].prototype;return i}static noConflict(){return window.MathQuill=this.origMathQuill,Dt}}Dt.origMathQuill=window.MathQuill;Dt.VERSION="0.10.1",window.MathQuill=Dt})();